<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <title>Sistem Absensi SMP Al-Azhar Muncar</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('https://www.alazharmuncar.ponpes.id/images/uploads/artikel/d4cec973b0.jpg') center center/cover no-repeat fixed;
      min-height: 100vh;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      touch-action: manipulation;
      position: relative;
    }

    /* Fallback jika gambar tidak bisa dimuat */
    body {
      background-color: #1e3a8a;
      background-image: 
        linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1d4ed8 100%),
        url('https://www.alazharmuncar.ponpes.id/images/uploads/artikel/d4cec973b0.jpg');
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: -1;
    }

    /* Login Page Styles */
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      padding: 30px 20px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      margin: 10px;
    }

    .school-logo {
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      color: white;
      overflow: hidden;
    }

    .school-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .login-title {
      color: #333;
      margin-bottom: 5px;
      font-size: 24px;
      font-weight: 600;
    }

    .login-subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #333;
      font-weight: 500;
      text-align: left;
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
      box-sizing: border-box;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    .form-input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .role-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .role-card {
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      padding: 15px 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .role-card:hover {
      border-color: #4CAF50;
      background: #f8fff8;
    }

    .role-card.active {
      border-color: #4CAF50;
      background: #e8f5e8;
    }

    .role-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .role-label {
      font-size: 11px;
      font-weight: 600;
      color: #333;
      line-height: 1.2;
      text-align: center;
    }

    .login-btn {
      width: 100%;
      background: #1e3a8a;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .login-btn:hover {
      background: #1d4ed8;
    }

    /* Main App Styles */
    .app-container {
      display: none;
      min-height: 100vh;
      background: #f5f7fa;
    }

    .header {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-logo {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      overflow: hidden;
    }

    .header-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .header-info h2 {
      margin: 0;
      color: #333;
      font-size: 18px;
    }

    .header-info p {
      margin: 0;
      color: #666;
      font-size: 12px;
    }

    .header-right {
      text-align: right;
    }

    .user-info {
      color: #333;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Dashboard Styles */
    .dashboard {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .greeting-box {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      text-align: center;
    }

    .greeting-box h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
    }

    .datetime {
      font-size: 16px;
      opacity: 0.9;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-bottom: 100px;
    }

    .menu-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .menu-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .menu-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      font-size: 24px;
      color: white;
    }

    .menu-card h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 18px;
    }

    .menu-card p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      z-index: 1000;
      border-top: 1px solid #e0e0e0;
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      padding: 8px 4px;
      border-radius: 8px;
      transition: background 0.3s;
      min-width: 50px;
      position: relative;
      flex: 1;
      max-width: 80px;
    }

    .nav-item:hover {
      background: #f0f0f0;
    }

    .nav-item.active {
      background: #e8f5e8;
      color: #4CAF50;
    }

    .nav-icon {
      font-size: 20px;
    }

    .nav-label {
      font-size: 9px;
      font-weight: 500;
      text-align: center;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* Dropup Menu */
    .dropup-menu {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 -8px 25px rgba(0,0,0,0.15);
      padding: 8px 0;
      margin-bottom: 10px;
      min-width: 160px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .dropup-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-5px);
    }

    .dropup-menu::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-top-color: white;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .dropup-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 14px;
      color: #333;
    }

    .dropup-item:hover {
      background: #f8f9fa;
    }

    .dropup-item:first-child {
      border-radius: 12px 12px 0 0;
    }

    .dropup-item:last-child {
      border-radius: 0 0 12px 12px;
    }

    .dropup-item-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    .dropup-item-text {
      font-weight: 500;
    }

    /* Overlay for closing dropup */
    .dropup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 999;
      display: none;
    }

    .dropup-overlay.show {
      display: block;
    }

    /* Page Content Styles */
    .page-content {
      display: none;
      padding: 15px;
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 90px;
      min-height: calc(100vh - 140px);
    }

    .page-content.active {
      display: block;
    }

    .page-header {
      background: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .page-title {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-subtitle {
      margin: 0;
      color: #666;
      font-size: 14px;
    }

    .content-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .filter-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .form-group-inline {
      display: flex;
      flex-direction: column;
    }

    .form-group-inline label {
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }

    .form-select, .form-input-inline {
      padding: 10px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
      padding-right: 35px;
    }

    .form-select.no-dropdown {
      background-image: none;
      padding-right: 10px;
    }

    .form-select:focus, .form-input-inline:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    .btn-success { background: #4CAF50; color: white; }
    .btn-warning { background: #FF9800; color: white; }
    .btn-info { background: #2196F3; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .btn-primary { background: #9C27B0; color: white; }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    /* Student List Styles */
    .student-list {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .student-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 20px;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.3s;
    }

    .student-item:hover {
      background: #f8f9fa;
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 15px;
      text-align: left;
    }

    .student-number {
      font-weight: 600;
      color: #666;
    }

    .student-name {
      font-weight: 600;
      color: #333;
    }

    .attendance-options {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-left: auto;
    }

    .attendance-btn {
      padding: 8px 12px;
      border: 2px solid;
      border-radius: 20px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s;
      background: white;
    }

    .attendance-btn.hadir { border-color: #4CAF50; color: #4CAF50; }
    .attendance-btn.sakit { border-color: #FF9800; color: #FF9800; }
    .attendance-btn.izin { border-color: #2196F3; color: #2196F3; }
    .attendance-btn.alpha { border-color: #f44336; color: #f44336; }

    .attendance-btn.active.hadir { background: #4CAF50; color: white; }
    .attendance-btn.active.sakit { background: #FF9800; color: white; }
    .attendance-btn.active.izin { background: #2196F3; color: white; }
    .attendance-btn.active.alpha { background: #f44336; color: white; }

    .attendance-dropdown {
      padding: 8px 10px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 100px;
      max-width: 110px;
      width: 100%;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 14px;
      padding-right: 28px;
    }

    .attendance-dropdown:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .attendance-dropdown.hadir {
      border-color: #4CAF50;
      background-color: #f8fff8;
      color: #4CAF50;
    }

    .attendance-dropdown.sakit {
      border-color: #FF9800;
      background-color: #fff8f0;
      color: #FF9800;
    }

    .attendance-dropdown.izin {
      border-color: #2196F3;
      background-color: #f0f8ff;
      color: #2196F3;
    }

    .attendance-dropdown.alpha {
      border-color: #f44336;
      background-color: #fff8f8;
      color: #f44336;
    }

    .attendance-dropdown option {
      padding: 10px;
      font-weight: 600;
      background: white;
      color: #333;
    }

    /* Form Layout Styles for Absensi */
    .absensi-form-layout {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Form Layout Styles for Jurnal */
    .jurnal-form-layout {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Form Layout Styles for Nilai */
    .nilai-form-layout {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .form-row {
      display: flex;
      gap: 10px;
      width: 100%;
    }

    .form-half {
      flex: 1;
      min-width: 0;
    }

    .form-compact {
      padding: 8px 10px;
      font-size: 13px;
      border: 1px solid #e1e5e9;
      border-radius: 6px;
    }

    .form-compact.no-dropdown {
      background-image: none;
      padding-right: 10px;
    }

    .form-compact:focus {
      outline: none;
      border-color: #4CAF50;
    }

    .form-half label {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      display: block;
    }

    .form-group-inline label {
      font-size: 12px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      display: block;
    }

    /* Mobile Responsive Design */
    @media (max-width: 768px) {
      .login-container {
        padding: 15px;
      }
      
      .login-card {
        padding: 25px 15px;
        margin: 5px;
      }
      
      .role-cards {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }
      
      .role-card {
        padding: 12px 6px;
      }
      
      .role-icon {
        font-size: 22px;
        margin-bottom: 6px;
      }
      
      .role-label {
        font-size: 11px;
        line-height: 1.2;
      }

      .header {
        padding: 8px 12px;
      }

      .header-left {
        gap: 8px;
      }

      .header-logo {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }

      .header-info h2 {
        font-size: 14px;
      }
      
      .header-info p {
        font-size: 11px;
      }
      
      .user-info {
        font-size: 12px;
      }
      
      .logout-btn {
        padding: 6px 12px;
        font-size: 11px;
      }

      .dashboard {
        padding: 12px;
      }

      .greeting-box {
        padding: 15px;
        margin-bottom: 20px;
      }

      .greeting-box h1 {
        font-size: 18px;
      }
      
      .datetime {
        font-size: 14px;
      }

      .menu-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 90px;
      }

      .menu-card {
        padding: 15px 12px;
      }
      
      .menu-icon {
        width: 45px;
        height: 45px;
        font-size: 18px;
      }
      
      .menu-card h3 {
        font-size: 14px;
        margin: 0 0 8px 0;
        line-height: 1.2;
      }
      
      .menu-card p {
        font-size: 11px;
        line-height: 1.3;
        margin: 0;
      }

      .page-content {
        padding: 12px;
        padding-bottom: 85px;
      }
      
      .page-header {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .page-title {
        font-size: 20px;
      }
      
      .page-subtitle {
        font-size: 13px;
      }
      
      .content-card {
        padding: 18px;
        margin-bottom: 15px;
      }

      .filter-section {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      /* Special mobile layout for Rekap pages */
      #rekapAbsensiContent .filter-section,
      #rekapJurnalContent .filter-section,
      #rekapNilaiContent .filter-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* Row layout for Rekap Absensi - Kelas & Guru sejajar */
      #rekapAbsensiContent .filter-section .form-group-inline:nth-child(1),
      #rekapAbsensiContent .filter-section .form-group-inline:nth-child(2) {
        display: inline-block;
        width: calc(50% - 4px);
        vertical-align: top;
      }

      #rekapAbsensiContent .filter-section .form-group-inline:nth-child(1) {
        margin-right: 8px;
      }

      /* Row layout for Rekap Absensi - Tanggal Awal & Tanggal Akhir sejajar */
      #rekapAbsensiContent .filter-section .form-group-inline:nth-child(4),
      #rekapAbsensiContent .filter-section .form-group-inline:nth-child(5) {
        display: inline-block;
        width: calc(50% - 4px);
        vertical-align: top;
      }

      #rekapAbsensiContent .filter-section .form-group-inline:nth-child(4) {
        margin-right: 8px;
      }

      /* Row layout for Rekap Jurnal - Kelas & Guru sejajar */
      #rekapJurnalContent .filter-section .form-group-inline:nth-child(1),
      #rekapJurnalContent .filter-section .form-group-inline:nth-child(2) {
        display: inline-block;
        width: calc(50% - 4px);
        vertical-align: top;
      }

      #rekapJurnalContent .filter-section .form-group-inline:nth-child(1) {
        margin-right: 8px;
      }

      /* Row layout for Rekap Jurnal - Tanggal Awal & Tanggal Akhir sejajar */
      #rekapJurnalContent .filter-section .form-group-inline:nth-child(4),
      #rekapJurnalContent .filter-section .form-group-inline:nth-child(5) {
        display: inline-block;
        width: calc(50% - 4px);
        vertical-align: top;
      }

      #rekapJurnalContent .filter-section .form-group-inline:nth-child(4) {
        margin-right: 8px;
      }

      /* Row layout for Rekap Nilai - Kelas & Mata Pelajaran sejajar */
      #rekapNilaiContent .filter-section .form-group-inline:nth-child(1),
      #rekapNilaiContent .filter-section .form-group-inline:nth-child(2) {
        display: inline-block;
        width: calc(50% - 4px);
        vertical-align: top;
      }

      #rekapNilaiContent .filter-section .form-group-inline:nth-child(1) {
        margin-right: 8px;
      }

      /* Smaller form elements for Rekap pages on mobile */
      #rekapAbsensiContent .form-group-inline label,
      #rekapJurnalContent .form-group-inline label,
      #rekapNilaiContent .form-group-inline label {
        font-size: 11px;
        margin-bottom: 3px;
        font-weight: 600;
      }

      #rekapAbsensiContent .form-select,
      #rekapAbsensiContent .form-input-inline,
      #rekapJurnalContent .form-select,
      #rekapJurnalContent .form-input-inline,
      #rekapNilaiContent .form-select,
      #rekapNilaiContent .form-input-inline {
        padding: 6px 8px;
        font-size: 11px;
        border-radius: 6px;
        border: 1px solid #e1e5e9;
        background-size: 12px;
        background-position: right 6px center;
        padding-right: 24px;
      }

      /* Override for absensi, jurnal, and nilai form layout on mobile */
      .absensi-form-layout,
      .jurnal-form-layout,
      .nilai-form-layout {
        gap: 10px;
      }

      .form-row {
        gap: 8px;
      }

      .form-compact {
        padding: 7px 8px;
        font-size: 12px;
      }

      .form-half label,
      .form-group-inline label {
        font-size: 11px;
        margin-bottom: 3px;
      }

      .action-buttons {
        flex-direction: row;
        gap: 6px;
        flex-wrap: wrap;
      }
      
      .btn {
        padding: 10px 8px;
        font-size: 12px;
        justify-content: center;
        flex: 1;
        min-width: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .student-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 15px;
        gap: 10px;
      }

      .student-info {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        text-align: left;
      }

      .student-number {
        font-weight: 600;
        color: #666;
        min-width: 25px;
        text-align: left;
      }

      .student-name {
        font-weight: 600;
        color: #333;
        flex: 1;
        word-wrap: break-word;
        line-height: 1.3;
        text-align: left;
      }

      .attendance-options {
        display: flex;
        justify-content: flex-end;
        flex-shrink: 0;
        margin-left: auto;
      }
      
      .attendance-btn {
        padding: 6px 10px;
        font-size: 11px;
      }

      .attendance-dropdown {
        min-width: 95px;
        max-width: 105px;
        font-size: 12px;
        padding: 6px 8px;
        padding-right: 26px;
      }
      
      .data-table {
        font-size: 12px;
      }
      
      .data-table th,
      .data-table td {
        padding: 8px 6px;
      }
      
      .nilai-input {
        width: 60px;
        padding: 6px;
        font-size: 12px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
      }
      
      .stat-card {
        padding: 15px;
      }
      
      .stat-number {
        font-size: 14px;
      }
      
      .stat-label {
        font-size: 10px;
      }
      
      .dropup-menu {
        min-width: 140px;
        bottom: 110%;
      }
      
      .dropup-item {
        padding: 10px 12px;
        font-size: 13px;
      }
    }
    
    /* Extra Small Mobile Devices */
    @media (max-width: 480px) {
      .login-card {
        padding: 20px 12px;
      }
      
      .role-cards {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .header-info h2 {
        font-size: 13px;
      }
      
      .greeting-box h1 {
        font-size: 16px;
      }
      
      .menu-card {
        padding: 15px;
      }
      
      .page-title {
        font-size: 18px;
      }
      
      .filter-section {
        gap: 8px;
      }
      
      .content-card {
        padding: 15px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }
      
      .nav-item {
        padding: 6px 2px;
        min-width: 45px;
      }
      
      .nav-icon {
        font-size: 18px;
      }
      
      .nav-label {
        font-size: 8px;
      }
    }
    
    /* Landscape Mobile Orientation */
    @media (max-width: 768px) and (orientation: landscape) {
      .menu-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
    }

    .hidden {
      display: none !important;
    }

    /* Loading Animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    /* Table Styles */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-size: 14px;
    }

    .data-table th {
      background: #f8f9fa;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #e9ecef;
    }

    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
    }

    .data-table tr:hover {
      background: #f8f9fa;
    }

    /* Input Nilai Styles */
    .nilai-input {
      width: 80px;
      padding: 8px;
      border: 2px solid #e1e5e9;
      border-radius: 5px;
      text-align: center;
      font-weight: 600;
    }

    .nilai-input:focus {
      outline: none;
      border-color: #4CAF50;
    }

    /* Statistics Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-number {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #666;
      font-size: 11px;
    }

    /* Loading indicator */
    .loading-indicator {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Login Page -->
  <div id="loginPage" class="login-container">
   <div class="login-card">
    <div class="school-logo"><img src="https://alazharmuncar.ponpes.id/assets/front/img/logo-smp.png" alt="Logo SMP Al-Azhar Muncar" onerror="this.style.display='none'; this.parentElement.innerHTML='üè´'; this.parentElement.style.background='#4CAF50';">
    </div>
    <h1 class="login-title">Absensi dan Jurnal</h1>
    <p class="login-subtitle">SMP Al-Azhar Muncar</p>
    <form id="loginForm">
     <div class="form-group"><label>Username</label> <input type="text" id="username" class="form-input" placeholder="Masukkan username" required>
     </div>
     <div class="form-group"><label>Password</label> <input type="password" id="password" class="form-input" placeholder="Masukkan password" required>
     </div>
     <div class="form-group"><label>Login Sebagai</label>
      <div class="role-cards" id="roleCards">
       <div style="text-align: center; color: #666; padding: 20px; font-style: italic;">
        Masukkan username terlebih dahulu
       </div>
      </div>
     </div><button type="submit" class="login-btn"> Masuk </button>
    </form>
   </div>
  </div><!-- Main Application -->
  <div id="mainApp" class="app-container"><!-- Header -->
   <div class="header">
    <div class="header-left">
     <div class="header-logo"><img src="https://alazharmuncar.ponpes.id/assets/front/img/logo-smp.png" alt="Logo SMP Al-Azhar Muncar" onerror="this.style.display='none'; this.parentElement.innerHTML='üè´'; this.parentElement.style.background='#4CAF50';">
     </div>
     <div class="header-info">
      <h2>Absensi dan Jurnal</h2>
      <p>SMP Al-Azhar Muncar</p>
     </div>
    </div>
    <div class="header-right">
     <div class="user-info" id="userInfo">
      Selamat datang, Guru
     </div><button class="logout-btn" onclick="logout()">Keluar</button>
    </div>
   </div><!-- Dashboard Content -->
   <div id="dashboardContent" class="page-content active">
    <div class="dashboard">
     <div class="greeting-box">
      <h1 id="greetingText">Selamat Datang, Guru!</h1>
      <div class="datetime" id="currentDateTime"></div>
     </div>
     <div class="menu-grid" id="menuGrid">
      <div class="menu-card" onclick="showPage('absensi')">
       <div class="menu-icon" style="background: #4CAF50;">
        üìù
       </div>
       <h3>Absensi Siswa</h3>
       <p>Input kehadiran siswa per kelas dan mata pelajaran</p>
      </div>
      <div class="menu-card" onclick="showPage('jurnal')">
       <div class="menu-icon" style="background: #2196F3;">
        üìñ
       </div>
       <h3>Jurnal Mengajar</h3>
       <p>Catat kegiatan pembelajaran harian</p>
      </div>
      <div class="menu-card" onclick="showPage('nilai')">
       <div class="menu-icon" style="background: #FF9800;">
        ‚≠ê
       </div>
       <h3>Input Nilai</h3>
       <p>Input nilai siswa berdasarkan jenis penilaian</p>
      </div>
      <div class="menu-card" onclick="showPage('rekapAbsensi')">
       <div class="menu-icon" style="background: #9C27B0;">
        üìä
       </div>
       <h3>Rekap Absensi</h3>
       <p>Laporan kehadiran siswa dalam rentang waktu</p>
      </div>
      <div class="menu-card" onclick="showPage('rekapJurnal')">
       <div class="menu-icon" style="background: #607D8B;">
        üìã
       </div>
       <h3>Rekap Jurnal</h3>
       <p>Laporan kegiatan pembelajaran</p>
      </div>
      <div class="menu-card" onclick="showPage('rekapNilai')">
       <div class="menu-icon" style="background: #795548;">
        üéØ
       </div>
       <h3>Rekap Nilai</h3>
       <p>Laporan nilai siswa per mata pelajaran</p>
      </div>
     </div>
    </div>
   </div><!-- Absensi Page -->
   <div id="absensiContent" class="page-content">
    <div class="page-header">
     <h1 class="page-title">üìù Absensi Siswa</h1>
     <p class="page-subtitle">Input kehadiran siswa per kelas dan mata pelajaran</p>
    </div>
    <div class="content-card">
     <div class="filter-section absensi-form-layout"><!-- Row 1: Kelas dan Mata Pelajaran -->
      <div class="form-row">
       <div class="form-group-inline form-half"><label>Kelas</label> <select id="kelasAbsensi" class="form-select form-compact" onchange="loadStudents()"> <option value="">Pilih Kelas</option> </select>
       </div>
       <div class="form-group-inline form-half"><label>Mata Pelajaran</label> <select id="mapelAbsensi" class="form-select form-compact"> <option value="Pendidikan Agama Islam">Pendidikan Agama Islam</option> <option value="Matematika">Matematika</option> <option value="Bahasa Indonesia">Bahasa Indonesia</option> <option value="Bahasa Inggris">Bahasa Inggris</option> <option value="IPA">IPA</option> <option value="IPS">IPS</option> </select>
       </div>
      </div><!-- Row 2: Jam Ke dan Tanggal -->
      <div class="form-row">
       <div class="form-group-inline form-half"><label>Jam Ke</label> <select id="jamAbsensi" class="form-select form-compact" onchange="loadStudents()"> <option value="Jam 1-2">Jam 1-2</option> <option value="Jam 3-4">Jam 3-4</option> <option value="Jam 5-6">Jam 5-6</option> <option value="Jam 7-8">Jam 7-8</option> <option value="Jam 9-10">Jam 9-10</option> </select>
       </div>
       <div class="form-group-inline form-half"><label>Tanggal</label> <input type="date" id="tanggalAbsensi" class="form-input-inline form-compact" onchange="loadStudents()">
       </div>
      </div><!-- Row 3: Guru (full width) -->
      <div class="form-group-inline"><label>Guru</label> <select id="guruAbsensi" class="form-select form-compact"> <option value="Ahmad Fauzi, S.Pd">Ahmad Fauzi, S.Pd</option> <option value="Siti Nurhaliza, S.Pd">Siti Nurhaliza, S.Pd</option> <option value="Budi Setiawan, S.Pd">Budi Setiawan, S.Pd</option> </select>
      </div>
     </div>
     <div class="action-buttons"><button class="btn btn-success" onclick="setAllAttendance('hadir')" style="font-family: 'Arial', sans-serif; font-size: 11px; letter-spacing: -0.3px;"> Semua Hadir </button> <button class="btn btn-warning" onclick="setAllAttendance('sakit')" style="font-family: 'Arial', sans-serif; font-size: 11px; letter-spacing: -0.3px;"> Semua Sakit </button> <button class="btn btn-info" onclick="setAllAttendance('izin')" style="font-family: 'Arial', sans-serif; font-size: 11px; letter-spacing: -0.3px;"> Semua Izin </button> <button class="btn btn-danger" onclick="setAllAttendance('alpha')" style="font-family: 'Arial', sans-serif; font-size: 11px; letter-spacing: -0.3px;"> Semua Alpha </button>
     </div>
    </div>
    <div class="content-card">
     <h3>Daftar Siswa</h3>
     <div id="studentList" class="student-list">
      <p style="text-align: center; color: #666; padding: 20px;">Pilih kelas untuk menampilkan daftar siswa</p>
     </div>
     <div style="text-align: center; margin-top: 20px;"><button class="btn btn-primary" onclick="saveAttendance()" id="saveAttendanceBtn" style="padding: 12px 30px; font-size: 16px;"> üíæ Simpan Absensi </button>
     </div>
    </div>
   </div><!-- Jurnal Page -->
   <div id="jurnalContent" class="page-content">
    <div class="page-header">
     <h1 class="page-title">üìñ Jurnal Mengajar</h1>
     <p class="page-subtitle">Catat kegiatan pembelajaran yang dilakukan</p>
    </div>
    <div class="content-card">
     <div class="filter-section jurnal-form-layout"><!-- Row 1: Kelas dan Mata Pelajaran -->
      <div class="form-row">
       <div class="form-group-inline form-half"><label>Kelas</label> <select id="kelasJurnal" class="form-select form-compact" onchange="checkJournalDuplicate()"> <option value="VII A">VII A</option> <option value="VII B">VII B</option> <option value="VIII A">VIII A</option> <option value="VIII B">VIII B</option> <option value="IX A">IX A</option> <option value="IX B">IX B</option> </select>
       </div>
       <div class="form-group-inline form-half"><label>Mata Pelajaran</label> <select id="mapelJurnal" class="form-select form-compact"> <option value="Pendidikan Agama Islam">Pendidikan Agama Islam</option> <option value="Matematika">Matematika</option> <option value="Bahasa Indonesia">Bahasa Indonesia</option> <option value="Bahasa Inggris">Bahasa Inggris</option> <option value="IPA">IPA</option> <option value="IPS">IPS</option> </select>
       </div>
      </div><!-- Row 2: Jam Ke dan Tanggal -->
      <div class="form-row">
       <div class="form-group-inline form-half"><label>Jam Ke</label> <select id="jamJurnal" class="form-select form-compact" onchange="checkJournalDuplicate()"> <option value="Jam 1-2">Jam 1-2</option> <option value="Jam 3-4">Jam 3-4</option> <option value="Jam 5-6">Jam 5-6</option> <option value="Jam 7-8">Jam 7-8</option> <option value="Jam 9-10">Jam 9-10</option> </select>
       </div>
       <div class="form-group-inline form-half"><label>Tanggal</label> <input type="date" id="tanggalJurnal" class="form-input-inline form-compact" onchange="checkJournalDuplicate()">
       </div>
      </div><!-- Row 3: Guru (full width) -->
      <div class="form-group-inline"><label>Guru</label> <select id="guruJurnal" class="form-select form-compact"> <option value="Ahmad Fauzi, S.Pd">Ahmad Fauzi, S.Pd</option> <option value="Siti Nurhaliza, S.Pd">Siti Nurhaliza, S.Pd</option> <option value="Budi Setiawan, S.Pd">Budi Setiawan, S.Pd</option> </select>
      </div>
     </div>
     <div class="form-group"><label>Materi Pembelajaran</label> <textarea id="materiJurnal" class="form-input" rows="4" placeholder="Tuliskan materi yang diajarkan hari ini..."></textarea>
     </div>
     <div class="action-buttons"><button class="btn btn-primary" onclick="saveJournal()"> üíæ Simpan Jurnal </button> <button class="btn btn-warning" onclick="clearJournal()"> üóëÔ∏è Bersihkan Form </button>
     </div>
    </div>
   </div><!-- Nilai Page -->
   <div id="nilaiContent" class="page-content">
    <div class="page-header">
     <h1 class="page-title">‚≠ê Input Nilai Siswa</h1>
     <p class="page-subtitle">Input nilai siswa berdasarkan jenis penilaian</p>
    </div>
    <div class="content-card">
     <div class="nilai-form-layout"><!-- Row 1: Kelas dan Mata Pelajaran -->
      <div class="form-row">
       <div class="form-group-inline form-half"><label>Kelas</label> <select id="kelasNilai" class="form-select form-compact" onchange="loadStudentsForGrades()"> <option value="">Pilih Kelas</option> </select>
       </div>
       <div class="form-group-inline form-half"><label>Mata Pelajaran</label> <select id="mapelNilai" class="form-select form-compact"> <option value="Pendidikan Agama Islam">Pendidikan Agama Islam</option> <option value="Matematika">Matematika</option> <option value="Bahasa Indonesia">Bahasa Indonesia</option> <option value="Bahasa Inggris">Bahasa Inggris</option> <option value="IPA">IPA</option> <option value="IPS">IPS</option> </select>
       </div>
      </div><!-- Row 2: Jenis Penilaian dan Guru -->
      <div class="form-row">
       <div class="form-group-inline form-half"><label>Jenis Penilaian</label> <select id="jenisNilai" class="form-select form-compact"> <option value="Tugas">Tugas</option> <option value="Ulangan">Ulangan</option> <option value="UTS">UTS</option> <option value="UAS">UAS</option> </select>
       </div>
       <div class="form-group-inline form-half"><label>Guru</label> <select id="guruNilai" class="form-select form-compact"> <option value="Ahmad Fauzi, S.Pd">Ahmad Fauzi, S.Pd</option> <option value="Siti Nurhaliza, S.Pd">Siti Nurhaliza, S.Pd</option> <option value="Budi Setiawan, S.Pd">Budi Setiawan, S.Pd</option> </select>
       </div>
      </div><!-- Row 3: Topik Penilaian (full width, no dropdown arrow) -->
      <div class="form-group-inline"><label>Topik Penilaian</label> <input type="text" id="topikNilai" class="form-input-inline form-compact" placeholder="Contoh: Sistem Persamaan Linear">
      </div>
     </div>
    </div>
    <div class="content-card">
     <h3>Daftar Siswa</h3>
     <div style="overflow-x: auto;">
      <table class="data-table" id="gradesTable">
       <thead>
        <tr>
         <th style="width: 60px; font-size: 13px;">No</th>
         <th style="font-size: 13px;">Nama Siswa</th>
         <th style="width: 120px; font-size: 13px;">Nilai (0-100)</th>
        </tr>
       </thead>
       <tbody id="gradesTableBody">
        <tr>
         <td colspan="3" style="text-align: center; color: #666; padding: 20px; font-size: 13px;">Pilih kelas untuk menampilkan daftar siswa</td>
        </tr>
       </tbody>
      </table>
     </div>
     <div style="text-align: center; margin-top: 20px;"><button class="btn btn-primary" onclick="saveGrades()" style="padding: 12px 30px; font-size: 16px;"> üíæ Simpan Nilai </button>
     </div>
    </div>
   </div><!-- Rekap Absensi Page -->
   <div id="rekapAbsensiContent" class="page-content">
    <div class="page-header">
     <h1 class="page-title">üìä Rekap Absensi</h1>
     <p class="page-subtitle">Laporan kehadiran siswa dalam rentang waktu tertentu</p>
    </div>
    <div class="content-card">
     <div class="filter-section"><!-- Row 1: Kelas dan Mata Pelajaran -->
      <div class="form-row">
       <div class="form-group-inline form-half"><label>Kelas</label> <select id="kelasRekapAbsensi" class="form-select form-compact"> <option value="">Semua Kelas</option> <option value="VII A">VII A</option> <option value="VII B">VII B</option> <option value="VIII A">VIII A</option> <option value="VIII B">VIII B</option> <option value="IX A">IX A</option> <option value="IX B">IX B</option> </select>
       </div>
       <div class="form-group-inline form-half"><label>Mata Pelajaran</label> <select id="mapelRekapAbsensi" class="form-select form-compact"> <option value="">Semua Mapel</option> <option value="Pendidikan Agama Islam">Pendidikan Agama Islam</option> <option value="Matematika">Matematika</option> <option value="Bahasa Indonesia">Bahasa Indonesia</option> <option value="Bahasa Inggris">Bahasa Inggris</option> <option value="IPA">IPA</option> <option value="IPS">IPS</option> </select>
       </div>
      </div><!-- Row 2: Guru (full width) -->
      <div class="form-group-inline"><label>Guru</label> <select id="guruRekapAbsensi" class="form-select form-compact"> <option value="">Semua Guru</option> <option value="Ahmad Fauzi, S.Pd">Ahmad Fauzi, S.Pd</option> <option value="Siti Nurhaliza, S.Pd">Siti Nurhaliza, S.Pd</option> <option value="Budi Setiawan, S.Pd">Budi Setiawan, S.Pd</option> </select>
      </div><!-- Row 3: Tanggal Awal dan Tanggal Akhir -->
      <div class="form-row">
       <div class="form-group-inline form-half"><label>Tanggal Awal</label> <input type="date" id="tanggalAwalAbsensi" class="form-input-inline form-compact">
       </div>
       <div class="form-group-inline form-half"><label>Tanggal Akhir</label> <input type="date" id="tanggalAkhirAbsensi" class="form-input-inline form-compact">
       </div>
      </div>
     </div>
     <div class="action-buttons"><button class="btn btn-primary" onclick="filterAttendanceReport()"> Filter Data </button> <button class="btn btn-info" onclick="showAttendanceStats()"> Statistik </button> <button class="btn btn-warning" onclick="toggleReportView()" id="toggleViewBtn"> Tampilan Ringkas </button> <button class="btn btn-danger" onclick="downloadPDF('absensi')"> Download PDF </button>
     </div>
    </div>
    <div class="stats-grid" id="attendanceStatsGrid">
     <div class="stat-card">
      <div class="stat-number" style="color: #4CAF50;" id="attendancePercentage">
       85%
      </div>
      <div class="stat-label">
       Tingkat Kehadiran
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" style="color: #FF9800;" id="sickPercentage">
       8%
      </div>
      <div class="stat-label">
       Sakit
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" style="color: #2196F3;" id="permitPercentage">
       5%
      </div>
      <div class="stat-label">
       Izin
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" style="color: #f44336;" id="absentPercentage">
       2%
      </div>
      <div class="stat-label">
       Alpha
      </div>
     </div>
    </div><!-- Detailed Report View -->
    <div class="content-card" id="detailedReportView">
     <h3>Data Absensi Rinci</h3>
     <div style="overflow-x: auto;">
      <table class="data-table">
       <thead>
        <tr>
         <th>Tanggal</th>
         <th>Nama Siswa</th>
         <th>L/P</th>
         <th>Kelas</th>
         <th>Jam</th>
         <th>Mata Pelajaran</th>
         <th>Status</th>
        </tr>
       </thead>
       <tbody id="attendanceReportTable">
        <tr>
         <td colspan="7" style="text-align: center; color: #666; padding: 20px;">
          <div class="loading-indicator">
           Memuat data absensi...
          </div></td>
        </tr>
       </tbody>
      </table>
     </div>
    </div><!-- Summary Report View -->
    <div class="content-card hidden" id="summaryReportView">
     <h3>Rekap Absensi per Siswa</h3>
     <div style="overflow-x: auto;">
      <table class="data-table">
       <thead>
        <tr>
         <th>No</th>
         <th>Nama Siswa</th>
         <th>Kelas</th>
         <th>L/P</th>
         <th style="color: #4CAF50;">Hadir</th>
         <th style="color: #FF9800;">Sakit</th>
         <th style="color: #2196F3;">Izin</th>
         <th style="color: #f44336;">Alpha</th>
         <th>Total</th>
         <th>% Kehadiran</th>
        </tr>
       </thead>
       <tbody id="attendanceSummaryTable">
        <tr>
         <td colspan="10" style="text-align: center; color: #666; padding: 20px;">
          <div class="loading-indicator">
           Memuat ringkasan absensi...
          </div></td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
   </div><!-- Rekap Jurnal Page -->
   <div id="rekapJurnalContent" class="page-content">
    <div class="page-header">
     <h1 class="page-title">üìã Rekap Jurnal</h1>
     <p class="page-subtitle">Laporan kegiatan pembelajaran</p>
    </div>
    <div class="content-card">
     <div class="filter-section"><!-- Row 1: Kelas dan Mata Pelajaran -->
      <div class="form-row">
       <div class="form-group-inline form-half"><label>Kelas</label> <select id="kelasRekapJurnal" class="form-select form-compact"> <option value="">Semua Kelas</option> <option value="VII A">VII A</option> <option value="VII B">VII B</option> <option value="VIII A">VIII A</option> <option value="VIII B">VIII B</option> <option value="IX A">IX A</option> <option value="IX B">IX B</option> </select>
       </div>
       <div class="form-group-inline form-half"><label>Mata Pelajaran</label> <select id="mapelRekapJurnal" class="form-select form-compact"> <option value="">Semua Mapel</option> <option value="Pendidikan Agama Islam">Pendidikan Agama Islam</option> <option value="Matematika">Matematika</option> <option value="Bahasa Indonesia">Bahasa Indonesia</option> <option value="Bahasa Inggris">Bahasa Inggris</option> <option value="IPA">IPA</option> <option value="IPS">IPS</option> </select>
       </div>
      </div><!-- Row 2: Guru (full width) -->
      <div class="form-group-inline"><label>Guru</label> <select id="guruRekapJurnal" class="form-select form-compact"> <option value="">Semua Guru</option> <option value="Ahmad Fauzi, S.Pd">Ahmad Fauzi, S.Pd</option> <option value="Siti Nurhaliza, S.Pd">Siti Nurhaliza, S.Pd</option> <option value="Budi Setiawan, S.Pd">Budi Setiawan, S.Pd</option> </select>
      </div><!-- Row 3: Tanggal Awal dan Tanggal Akhir -->
      <div class="form-row">
       <div class="form-group-inline form-half"><label>Tanggal Awal</label> <input type="date" id="tanggalAwalJurnal" class="form-input-inline form-compact">
       </div>
       <div class="form-group-inline form-half"><label>Tanggal Akhir</label> <input type="date" id="tanggalAkhirJurnal" class="form-input-inline form-compact">
       </div>
      </div>
     </div>
     <div class="action-buttons"><button class="btn btn-primary" onclick="filterJournalReport()"> Filter Data </button> <button class="btn btn-danger" onclick="downloadPDF('jurnal')"> Download PDF </button>
     </div>
    </div>
    <div class="content-card">
     <h3>Data Jurnal Mengajar</h3>
     <div style="overflow-x: auto;">
      <table class="data-table">
       <thead>
        <tr>
         <th>Tanggal</th>
         <th>Kelas</th>
         <th>Jam</th>
         <th>Mata Pelajaran</th>
         <th>Materi</th>
         <th>Guru</th>
        </tr>
       </thead>
       <tbody id="journalReportTable">
        <tr>
         <td colspan="6" style="text-align: center; color: #666; padding: 20px;">
          <div class="loading-indicator">
           Memuat data jurnal...
          </div></td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
   </div><!-- Rekap Nilai Page -->
   <div id="rekapNilaiContent" class="page-content">
    <div class="page-header">
     <h1 class="page-title">üéØ Rekap Nilai</h1>
     <p class="page-subtitle">Laporan nilai siswa per mata pelajaran</p>
    </div>
    <div class="content-card">
     <div class="filter-section">
      <div class="form-group-inline"><label>Kelas</label> <select id="kelasRekapNilai" class="form-select"> <option value="">Semua Kelas</option> <option value="VII A">VII A</option> <option value="VII B">VII B</option> <option value="VIII A">VIII A</option> <option value="VIII B">VIII B</option> <option value="IX A">IX A</option> <option value="IX B">IX B</option> </select>
      </div>
      <div class="form-group-inline"><label>Mata Pelajaran</label> <select id="mapelRekapNilai" class="form-select"> <option value="">Semua Mapel</option> <option value="Pendidikan Agama Islam">Pendidikan Agama Islam</option> <option value="Matematika">Matematika</option> <option value="Bahasa Indonesia">Bahasa Indonesia</option> <option value="Bahasa Inggris">Bahasa Inggris</option> <option value="IPA">IPA</option> <option value="IPS">IPS</option> </select>
      </div>
      <div class="form-group-inline"><label>Jenis Penilaian</label> <select id="jenisRekapNilai" class="form-select"> <option value="">Semua Jenis</option> <option value="Tugas">Tugas</option> <option value="Ulangan">Ulangan</option> <option value="UTS">UTS</option> <option value="UAS">UAS</option> </select>
      </div>
     </div>
     <div class="action-buttons"><button class="btn btn-primary" onclick="filterGradesReport()"> Filter Data </button> <button class="btn btn-info" onclick="showGradesStats()"> Statistik </button> <button class="btn btn-danger" onclick="downloadPDF('nilai')"> Download PDF </button>
     </div>
    </div>
    <div class="stats-grid" id="gradesStatsGrid">
     <div class="stat-card">
      <div class="stat-number" style="color: #4CAF50;" id="averageGrade">
       78.5
      </div>
      <div class="stat-label">
       Rata-rata Kelas
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" style="color: #2196F3;" id="highestGrade">
       95
      </div>
      <div class="stat-label">
       Nilai Tertinggi
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" style="color: #FF9800;" id="lowestGrade">
       65
      </div>
      <div class="stat-label">
       Nilai Terendah
      </div>
     </div>
     <div class="stat-card">
      <div class="stat-number" style="color: #9C27B0;" id="totalStudents">
       25
      </div>
      <div class="stat-label">
       Jumlah Siswa
      </div>
     </div>
    </div>
    <div class="content-card">
     <h3>Data Nilai Siswa</h3>
     <div style="overflow-x: auto;">
      <table class="data-table">
       <thead>
        <tr>
         <th>Nama Siswa</th>
         <th>Kelas</th>
         <th>Mata Pelajaran</th>
         <th>Jenis</th>
         <th>Topik</th>
         <th>Nilai</th>
        </tr>
       </thead>
       <tbody id="gradesReportTable">
        <tr>
         <td>Ahmad Fauzi</td>
         <td>VII A</td>
         <td>Matematika</td>
         <td>Ulangan</td>
         <td>Sistem Persamaan Linear</td>
         <td><span style="color: #4CAF50; font-weight: 600;">85</span></td>
        </tr>
        <tr>
         <td>Siti Nurhaliza</td>
         <td>VII A</td>
         <td>Matematika</td>
         <td>Ulangan</td>
         <td>Sistem Persamaan Linear</td>
         <td><span style="color: #2196F3; font-weight: 600;">78</span></td>
        </tr>
        <tr>
         <td>Budi Setiawan</td>
         <td>VII A</td>
         <td>Matematika</td>
         <td>Ulangan</td>
         <td>Sistem Persamaan Linear</td>
         <td><span style="color: #4CAF50; font-weight: 600;">92</span></td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
   </div><!-- Bottom Navigation -->
   <div class="bottom-nav" id="bottomNav">
    <div class="nav-item active" onclick="showPage('dashboard')">
     <div class="nav-icon">
      üè†
     </div>
     <div class="nav-label">
      Dashboard
     </div>
    </div>
    <div class="nav-item" onclick="showPage('absensi')">
     <div class="nav-icon">
      üìù
     </div>
     <div class="nav-label">
      Absensi
     </div>
    </div>
    <div class="nav-item" onclick="showPage('jurnal')">
     <div class="nav-icon">
      üìñ
     </div>
     <div class="nav-label">
      Jurnal
     </div>
    </div>
    <div class="nav-item" onclick="showPage('nilai')">
     <div class="nav-icon">
      ‚≠ê
     </div>
     <div class="nav-label">
      Nilai
     </div>
    </div>
    <div class="nav-item" onclick="toggleDropup(event)">
     <div class="nav-icon">
      üìä
     </div>
     <div class="nav-label">
      Rekap
     </div>
     <div class="dropup-menu" id="rekapDropup">
      <div class="dropup-item" onclick="selectRekapPage('rekapAbsensi')">
       <div class="dropup-item-icon">
        üìä
       </div>
       <div class="dropup-item-text">
        Rekap Absensi
       </div>
      </div>
      <div class="dropup-item" onclick="selectRekapPage('rekapJurnal')">
       <div class="dropup-item-icon">
        üìã
       </div>
       <div class="dropup-item-text">
        Rekap Jurnal
       </div>
      </div>
      <div class="dropup-item" onclick="selectRekapPage('rekapNilai')">
       <div class="dropup-item-icon">
        üéØ
       </div>
       <div class="dropup-item-text">
        Rekap Nilai
       </div>
      </div>
     </div>
    </div>
   </div><!-- Dropup Overlay -->
   <div class="dropup-overlay" id="dropupOverlay" onclick="closeDropup()"></div>
  </div>
  <script>
    // Global variables
    let currentUser = null;
    let currentPage = 'dashboard';

    // User data from Google Sheets
    let usersData = {};
    let isLoadingUsers = false;

    // Student data from Google Sheets
    let studentsData = {};
    let isLoadingStudents = false;

    // Teacher data from Google Sheets
    let teachersData = {};
    let isLoadingTeachers = false;

    // Attendance report data
    let attendanceReportData = [];
    let isLoadingAttendanceReport = false;

    // Journal report data
    let journalReportData = [];
    let isLoadingJournalReport = false;

    // Grades report data
    let gradesReportData = [];
    let isLoadingGradesReport = false;

    // Load user data from Google Sheets
    async function loadUsersFromGoogleSheets() {
      if (isLoadingUsers) return;
      
      isLoadingUsers = true;
      const loginBtn = document.querySelector('.login-btn');
      const originalText = loginBtn.innerHTML;
      loginBtn.innerHTML = '‚è≥ Memuat data...';
      loginBtn.disabled = true;

      try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRiSLdyRVtn6R5Ga87BmGd55VpRK16SOaCefvBYA4wRCfYu3_IECTva3-wilQMS0O0naftUKpdihxsH/pub?gid=0&single=true&output=csv');
        const csvText = await response.text();
        
        console.log('Raw CSV data:', csvText.substring(0, 500)); // Debug log
        
        // Parse CSV data
        const lines = csvText.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        console.log('CSV Headers found:', headers); // Debug log
        
        usersData = {};
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          // Parse CSV line with proper handling of quoted fields
          const values = parseCSVLine(line);
          if (values.length < headers.length) continue;
          
          const userData = {};
          headers.forEach((header, index) => {
            userData[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
          });
          
          console.log('Processing user row:', userData); // Debug log
          
          // Store user data with username as key - use exact column names
          if (userData.Username && userData.Password) {
            usersData[userData.Username] = {
              id: userData['id Guru'] || '',
              name: userData['Nama Guru'] || userData.Username,
              password: userData.Password,
              mapel: userData['Mata Pelajaran'] || '',
              kelas: userData['Kelas yang diampu'] || '',
              roles: userData.Role ? userData.Role.split(',').map(r => r.trim()) : ['Guru']
            };
            
            console.log('Added user:', userData.Username, usersData[userData.Username]); // Debug log
          }
        }
        
        console.log('Total loaded users:', Object.keys(usersData).length);
        console.log('All users data:', usersData); // Debug log
        
        if (Object.keys(usersData).length === 0) {
          console.warn('No users loaded from Google Sheets');
          // Add fallback data for testing
          usersData = {
            'admin': {
              id: '001',
              name: 'Administrator',
              password: 'admin123',
              mapel: '',
              kelas: '',
              roles: ['Administrator']
            },
            'guru1': {
              id: '002', 
              name: 'Ahmad Fauzi, S.Pd',
              password: 'guru123',
              mapel: 'Matematika',
              kelas: 'VII A, VII B',
              roles: ['Guru']
            }
          };
          console.log('Using fallback user data:', usersData);
        }
        
      } catch (error) {
        console.error('Error loading users:', error);
        alert('Gagal memuat data pengguna. Menggunakan data default untuk testing.');
        
        // Fallback data
        usersData = {
          'admin': {
            id: '001',
            name: 'Administrator',
            password: 'admin123',
            mapel: '',
            kelas: '',
            roles: ['Administrator']
          },
          'guru1': {
            id: '002',
            name: 'Ahmad Fauzi, S.Pd',
            password: 'guru123',
            mapel: 'Matematika',
            kelas: 'VII A, VII B',
            roles: ['Guru']
          }
        };
      } finally {
        isLoadingUsers = false;
        loginBtn.innerHTML = originalText;
        loginBtn.disabled = false;
      }
    }

    // Load teacher data from Google Sheets
    async function loadTeachersFromGoogleSheets() {
      if (isLoadingTeachers) return;
      
      isLoadingTeachers = true;
      
      try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRiSLdyRVtn6R5Ga87BmGd55VpRK16SOaCefvBYA4wRCfYu3_IECTva3-wilQMS0O0naftUKpdihxsH/pub?gid=0&single=true&output=csv');
        const csvText = await response.text();
        
        // Parse CSV data
        const lines = csvText.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        teachersData = {};
        
        console.log('CSV Headers:', headers); // Debug log
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          // Parse CSV line with proper handling of quoted fields
          const values = parseCSVLine(line);
          if (values.length < headers.length) continue;
          
          const teacherData = {};
          headers.forEach((header, index) => {
            teacherData[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
          });
          
          console.log('Teacher data row:', teacherData); // Debug log
          
          // Store teacher data with username as key
          if (teacherData.Username) {
            // Use exact column names from your sheet
            let kelasColumn = teacherData['Kelas yang diampu'] || '';
            let mapelColumn = teacherData['Mata Pelajaran'] || '';
            
            console.log('Kelas yang diampu value:', kelasColumn); // Debug log
            console.log('Mata Pelajaran value:', mapelColumn); // Debug log
            
            // Split and clean the data
            const kelasList = kelasColumn ? kelasColumn.split(',').map(k => k.trim()).filter(k => k) : [];
            const mapelList = mapelColumn ? mapelColumn.split(',').map(m => m.trim()).filter(m => m) : [];
            
            teachersData[teacherData.Username] = {
              nama: teacherData['Nama Guru'] || teacherData.Username,
              kelas: kelasList,
              mapel: mapelList,
              role: teacherData.Role || 'Guru'
            };
            
            console.log('Processed teacher:', teacherData.Username, teachersData[teacherData.Username]); // Debug log
            console.log('Teacher classes found:', kelasList); // Debug log
          }
        }
        
        console.log('Loaded teachers:', Object.keys(teachersData).length);
        console.log('All teachers data:', teachersData); // Debug log
        
      } catch (error) {
        console.error('Error loading teachers:', error);
        
        // Fallback to default data if loading fails
        teachersData = {
          'guru1': {
            nama: 'Ahmad Fauzi, S.Pd',
            kelas: ['VII A', 'VII B'],
            mapel: ['Matematika'],
            role: 'Guru'
          },
          'guru2': {
            nama: 'Siti Nurhaliza, S.Pd',
            kelas: ['VIII A', 'VIII B'],
            mapel: ['Bahasa Indonesia'],
            role: 'Guru'
          }
        };
        console.log('Using fallback teacher data:', teachersData);
      } finally {
        isLoadingTeachers = false;
      }
    }

    // Load student data from Google Sheets
    async function loadStudentsFromGoogleSheets() {
      if (isLoadingStudents) return;
      
      isLoadingStudents = true;
      
      try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSi_oxcUsjmD0EwTQo3j9Mj-DLvPPQhk3nGJbjOijO1vdAV4jkTiT68yVnvTMA54vy-BEXUmG_7UJw4/pub?gid=0&single=true&output=csv');
        const csvText = await response.text();
        
        // Parse CSV data
        const lines = csvText.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        studentsData = {};
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          // Parse CSV line with proper handling of quoted fields
          const values = parseCSVLine(line);
          if (values.length < headers.length) continue;
          
          const studentData = {};
          headers.forEach((header, index) => {
            studentData[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
          });
          
          // Group students by class
          if (studentData.NIS && studentData['Nama Lengkap'] && studentData.Kelas) {
            const kelas = studentData.Kelas;
            
            if (!studentsData[kelas]) {
              studentsData[kelas] = [];
            }
            
            studentsData[kelas].push({
              nis: studentData.NIS,
              nama: studentData['Nama Lengkap'],
              lp: studentData['L/P'] || 'L'
            });
          }
        }
        
        // Sort students by name in each class
        Object.keys(studentsData).forEach(kelas => {
          studentsData[kelas].sort((a, b) => a.nama.localeCompare(b.nama));
        });
        
        console.log('Loaded students by class:', Object.keys(studentsData));
        console.log('Total students:', Object.values(studentsData).reduce((total, students) => total + students.length, 0));
        
        // Populate dropdowns after loading data
        populateClassDropdowns();
        
      } catch (error) {
        console.error('Error loading students:', error);
        alert('Gagal memuat data siswa. Menggunakan data default.');
        
        // Fallback to default data if loading fails
        studentsData = {
          'VII A': [
            { nis: '2024001', nama: 'Ahmad Fauzi', lp: 'L' },
            { nis: '2024002', nama: 'Siti Nurhaliza', lp: 'P' }
          ]
        };
        
        // Populate dropdowns with fallback data
        populateClassDropdowns();
      } finally {
        isLoadingStudents = false;
      }
    }

    // Parse CSV line with proper handling of quoted fields
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current);
      return result;
    }

    // Load attendance report data from Google Sheets
    async function loadAttendanceReportData() {
      if (isLoadingAttendanceReport) return;
      
      isLoadingAttendanceReport = true;
      
      try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQYfSiGvS7RVqD6nxBEKSpXAJ9w1n8e0sEfbTtFeV4wDLxF1bk_vgCWt7zuXK9nfKLkPxDQg7A8MbPj/pub?gid=0&single=true&output=csv');
        const csvText = await response.text();
        
        // Parse CSV data
        const lines = csvText.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        attendanceReportData = [];
        
        console.log('Attendance CSV Headers:', headers);
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const values = parseCSVLine(line);
          if (values.length < headers.length) continue;
          
          const attendanceRecord = {};
          headers.forEach((header, index) => {
            attendanceRecord[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
          });
          
          // Only add records with required data
          if (attendanceRecord['Tanggal Absen'] && attendanceRecord['nama Lengkap'] && attendanceRecord['Kelas']) {
            attendanceReportData.push({
              tanggal: attendanceRecord['Tanggal Absen'],
              waktu: attendanceRecord['Waktu'] || '',
              nis: attendanceRecord['NIS'] || '',
              nama: attendanceRecord['nama Lengkap'],
              lp: attendanceRecord['L/P'] || 'L',
              kelas: attendanceRecord['Kelas'],
              jam: attendanceRecord['Jam Ke'] || '',
              mapel: attendanceRecord['Mata Pelajaran'] || '',
              status: attendanceRecord['Status'] || 'Hadir',
              keterangan: attendanceRecord['Keterangan'] || '',
              guru: attendanceRecord['Guru'] || ''
            });
          }
        }
        
        console.log('Loaded attendance records:', attendanceReportData.length);
        
      } catch (error) {
        console.error('Error loading attendance report data:', error);
        
        // Fallback sample data
        attendanceReportData = [
          {
            tanggal: '2024-01-15',
            waktu: '07:30:00',
            nis: '2024001',
            nama: 'Ahmad Fauzi',
            lp: 'L',
            kelas: 'VII A',
            jam: 'Jam 1-2',
            mapel: 'Matematika',
            status: 'Hadir',
            keterangan: '',
            guru: 'Siti Nurhaliza, S.Pd'
          },
          {
            tanggal: '2024-01-15',
            waktu: '07:30:00',
            nis: '2024002',
            nama: 'Siti Nurhaliza',
            lp: 'P',
            kelas: 'VII A',
            jam: 'Jam 1-2',
            mapel: 'Matematika',
            status: 'Sakit',
            keterangan: '',
            guru: 'Siti Nurhaliza, S.Pd'
          }
        ];
      } finally {
        isLoadingAttendanceReport = false;
      }
    }

    // Load journal report data from Google Sheets
    async function loadJournalReportData() {
      if (isLoadingJournalReport) return;
      
      isLoadingJournalReport = true;
      
      try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTTPGp6dwe1A9LNGnmJGEk7H460po1XIXl_Jt-l-kOA065fO16P19htojpXRGGRZ_ViZY_DWAdIHN_i/pub?gid=0&single=true&output=csv');
        const csvText = await response.text();
        
        // Parse CSV data
        const lines = csvText.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        journalReportData = [];
        
        console.log('Journal CSV Headers:', headers);
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const values = parseCSVLine(line);
          if (values.length < headers.length) continue;
          
          const journalRecord = {};
          headers.forEach((header, index) => {
            journalRecord[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
          });
          
          // Only add records with required data
          if (journalRecord['Tanggal'] && journalRecord['Guru'] && journalRecord['Kelas']) {
            journalReportData.push({
              tanggal: journalRecord['Tanggal'],
              waktu: journalRecord['Waktu'] || '',
              guru: journalRecord['Guru'],
              mapel: journalRecord['Mapel'] || '',
              kelas: journalRecord['Kelas'],
              jam: journalRecord['Jam Ke'] || '',
              materi: journalRecord['Materi'] || ''
            });
          }
        }
        
        console.log('Loaded journal records:', journalReportData.length);
        
      } catch (error) {
        console.error('Error loading journal report data:', error);
        
        // Fallback sample data
        journalReportData = [
          {
            tanggal: '2024-01-15',
            waktu: '07:30:00',
            guru: 'Siti Nurhaliza, S.Pd',
            mapel: 'Matematika',
            kelas: 'VII A',
            jam: 'Jam 1-2',
            materi: 'Sistem Persamaan Linear Dua Variabel - Metode Eliminasi'
          },
          {
            tanggal: '2024-01-15',
            waktu: '09:30:00',
            guru: 'Ahmad Fauzi, S.Pd',
            mapel: 'Bahasa Indonesia',
            kelas: 'VII B',
            jam: 'Jam 3-4',
            materi: 'Teks Deskripsi - Struktur dan Ciri Kebahasaan'
          },
          {
            tanggal: '2024-01-15',
            waktu: '11:30:00',
            guru: 'Budi Setiawan, S.Pd',
            mapel: 'IPA',
            kelas: 'VIII A',
            jam: 'Jam 5-6',
            materi: 'Sistem Gerak Manusia - Struktur dan Fungsi Tulang'
          }
        ];
      } finally {
        isLoadingJournalReport = false;
      }
    }

    // Load grades report data from Google Sheets
    async function loadGradesReportData() {
      if (isLoadingGradesReport) return;
      
      isLoadingGradesReport = true;
      
      try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3CrLXdYjnSXfMYRxylLGakqjGTK-2FnWFsOLf4KZt5HGb7XijXco6khGPywlcyTUSWvWWst0zwvqW/pub?gid=0&single=true&output=csv');
        const csvText = await response.text();
        
        // Parse CSV data
        const lines = csvText.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        gradesReportData = [];
        
        console.log('Grades CSV Headers:', headers);
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const values = parseCSVLine(line);
          if (values.length < headers.length) continue;
          
          const gradeRecord = {};
          headers.forEach((header, index) => {
            gradeRecord[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
          });
          
          // Only add records with required data
          if (gradeRecord['Tanggal'] && gradeRecord['Nama Siswa'] && gradeRecord['Nilai']) {
            gradesReportData.push({
              tanggal: gradeRecord['Tanggal'],
              kelas: gradeRecord['Kelas'] || '',
              mapel: gradeRecord['Mata Pelajaran'] || '',
              jenis: gradeRecord['Jenis Penilaian'] || '',
              topik: gradeRecord['Topik Penilaian'] || '',
              guru: gradeRecord['Guru'] || '',
              nama: gradeRecord['Nama Siswa'],
              nilai: parseInt(gradeRecord['Nilai']) || 0
            });
          }
        }
        
        console.log('Loaded grades records:', gradesReportData.length);
        
      } catch (error) {
        console.error('Error loading grades report data:', error);
        
        // Fallback sample data
        gradesReportData = [
          {
            tanggal: '2024-01-15',
            kelas: 'VII A',
            mapel: 'Matematika',
            jenis: 'Ulangan',
            topik: 'Sistem Persamaan Linear',
            guru: 'Siti Nurhaliza, S.Pd',
            nama: 'Ahmad Fauzi',
            nilai: 85
          },
          {
            tanggal: '2024-01-15',
            kelas: 'VII A',
            mapel: 'Matematika',
            jenis: 'Ulangan',
            topik: 'Sistem Persamaan Linear',
            guru: 'Siti Nurhaliza, S.Pd',
            nama: 'Siti Nurhaliza',
            nilai: 78
          },
          {
            tanggal: '2024-01-15',
            kelas: 'VII A',
            mapel: 'Matematika',
            jenis: 'Ulangan',
            topik: 'Sistem Persamaan Linear',
            guru: 'Siti Nurhaliza, S.Pd',
            nama: 'Budi Setiawan',
            nilai: 92
          }
        ];
      } finally {
        isLoadingGradesReport = false;
      }
    }

    // Update role cards based on username input
    function updateRoleCards() {
      const username = document.getElementById('username').value.trim();
      const roleCardsContainer = document.getElementById('roleCards');
      
      // Jika username kosong, sembunyikan semua role cards
      if (!username) {
        roleCardsContainer.innerHTML = `
          <div style="text-align: center; color: #666; padding: 20px; font-style: italic;">
            Masukkan username terlebih dahulu
          </div>
        `;
        return;
      }

      // Jika data user belum dimuat, tampilkan loading
      if (Object.keys(usersData).length === 0) {
        roleCardsContainer.innerHTML = `
          <div style="text-align: center; color: #666; padding: 20px; font-style: italic;">
            <div style="font-size: 20px; margin-bottom: 10px;">‚è≥</div>
            Memuat data pengguna...
          </div>
        `;
        return;
      }

      // Jika username tidak ditemukan di database
      if (!usersData[username]) {
        roleCardsContainer.innerHTML = `
          <div style="text-align: center; color: #f44336; padding: 20px; font-style: italic;">
            <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
            Username tidak ditemukan
          </div>
        `;
        return;
      }

      const user = usersData[username];
      const availableRoles = user.roles;
      
      // Role icons mapping - pastikan icon selalu ada dan konsisten
      const roleIcons = {
        'Administrator': 'üë®‚Äçüíº',
        'Guru': 'üë®‚Äçüè´',
        'Wali Kelas': 'üë®‚Äçüè´',
        'Wali Kelas 7A': 'üë®‚Äçüè´',
        'Wali Kelas 7B': 'üë®‚Äçüè´',
        'Wali Kelas 8A': 'üë®‚Äçüè´',
        'Wali Kelas 8B': 'üë®‚Äçüè´',
        'Wali Kelas 9A': 'üë®‚Äçüè´',
        'Wali Kelas 9B': 'üë®‚Äçüè´',
        'Kepala Sekolah': 'üéì',
        'Staff': 'üë•'
      };

      // Generate role cards for available roles
      let roleCardsHTML = '';
      availableRoles.forEach((role, index) => {
        // Pastikan icon selalu ada - jika role mengandung "Wali Kelas" gunakan icon guru
        let icon = roleIcons[role];
        if (!icon) {
          if (role.includes('Wali Kelas')) {
            icon = 'üë®‚Äçüè´';
          } else {
            icon = 'üë§';
          }
        }
        
        const isActive = index === 0 ? 'active' : '';
        const isChecked = index === 0 ? 'checked' : '';
        
        // Handle long role names
        const displayRole = role.length > 12 ? role.substring(0, 12) + '...' : role;
        
        roleCardsHTML += `
          <div class="role-card ${isActive}" onclick="selectRole('${role}')" title="${role}">
            <div class="role-icon">${icon}</div>
            <div class="role-label">${displayRole}</div>
            <input type="radio" name="role" value="${role}" ${isChecked} style="display: none;">
          </div>
        `;
      });

      roleCardsContainer.innerHTML = roleCardsHTML;
    }

    // Populate forms based on logged-in teacher
    function populateTeacherForms() {
      console.log('populateTeacherForms called');
      console.log('currentUser:', currentUser);
      console.log('teachersData keys:', Object.keys(teachersData));
      
      if (!currentUser) {
        console.log('No current user, using fallback');
        populateClassDropdowns();
        return;
      }
      
      const teacher = teachersData[currentUser.username];
      console.log('Found teacher data for', currentUser.username, ':', teacher);
      
      if (!teacher) {
        console.log('No teacher data found for user, using fallback');
        // If no teacher data, populate with all available data
        populateClassDropdowns();
        return;
      }

      // Populate Absensi form
      populateAbsensiForm(teacher);
      
      // Populate other forms
      populateOtherForms(teacher);
    }

    function populateAbsensiForm(teacher) {
      console.log('Populating absensi form for teacher:', teacher);
      console.log('Current user:', currentUser);
      console.log('All teachers data:', teachersData);
      
      // Set Guru field to logged-in teacher (read-only)
      const guruAbsensi = document.getElementById('guruAbsensi');
      if (guruAbsensi && teacher) {
        guruAbsensi.innerHTML = `<option value="${teacher.nama}" selected>${teacher.nama}</option>`;
        guruAbsensi.disabled = true;
        guruAbsensi.style.backgroundColor = '#f5f5f5';
        guruAbsensi.style.cursor = 'not-allowed';
        guruAbsensi.classList.add('no-dropdown');
      }

      // Populate Kelas dropdown with teacher's classes only
      const kelasAbsensi = document.getElementById('kelasAbsensi');
      if (kelasAbsensi) {
        if (teacher && teacher.kelas && teacher.kelas.length > 0) {
          console.log('Teacher classes found:', teacher.kelas);
          kelasAbsensi.innerHTML = '<option value="">Pilih Kelas</option>';
          teacher.kelas.forEach(kelas => {
            if (kelas && kelas.trim()) { // Make sure kelas is not empty
              const option = document.createElement('option');
              option.value = kelas.trim();
              option.textContent = kelas.trim();
              kelasAbsensi.appendChild(option);
              console.log('Added class to dropdown:', kelas.trim());
            }
          });
        } else {
          console.log('No classes found for teacher, using fallback');
          // Fallback: show limited classes if no teacher data
          kelasAbsensi.innerHTML = `
            <option value="">Pilih Kelas</option>
            <option value="VII A">VII A</option>
            <option value="VII B">VII B</option>
          `;
        }
      }

      // Populate Mata Pelajaran dropdown with teacher's subjects only
      const mapelAbsensi = document.getElementById('mapelAbsensi');
      if (mapelAbsensi) {
        if (teacher && teacher.mapel && teacher.mapel.length > 0) {
          console.log('Teacher subjects found:', teacher.mapel);
          mapelAbsensi.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
          teacher.mapel.forEach(mapel => {
            if (mapel && mapel.trim()) { // Make sure mapel is not empty
              const option = document.createElement('option');
              option.value = mapel.trim();
              option.textContent = mapel.trim();
              mapelAbsensi.appendChild(option);
              console.log('Added subject to dropdown:', mapel.trim());
            }
          });
        } else {
          console.log('No subjects found for teacher, using fallback');
          // Fallback: show limited subjects if no teacher data
          mapelAbsensi.innerHTML = `
            <option value="">Pilih Mata Pelajaran</option>
            <option value="Matematika">Matematika</option>
            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
          `;
        }
      }
    }

    function populateOtherForms(teacher) {
      // Populate Jurnal form
      const guruJurnal = document.getElementById('guruJurnal');
      if (guruJurnal && teacher) {
        guruJurnal.innerHTML = `<option value="${teacher.nama}" selected>${teacher.nama}</option>`;
        guruJurnal.disabled = true;
        guruJurnal.style.backgroundColor = '#f5f5f5';
        guruJurnal.style.cursor = 'not-allowed';
        guruJurnal.classList.add('no-dropdown');
      }

      const kelasJurnal = document.getElementById('kelasJurnal');
      if (kelasJurnal && teacher && teacher.kelas && teacher.kelas.length > 0) {
        kelasJurnal.innerHTML = '<option value="">Pilih Kelas</option>';
        teacher.kelas.forEach(kelas => {
          const option = document.createElement('option');
          option.value = kelas;
          option.textContent = kelas;
          kelasJurnal.appendChild(option);
        });
      } else if (kelasJurnal) {
        // Fallback for jurnal
        kelasJurnal.innerHTML = `
          <option value="">Pilih Kelas</option>
          <option value="VII A">VII A</option>
          <option value="VII B">VII B</option>
        `;
      }

      const mapelJurnal = document.getElementById('mapelJurnal');
      if (mapelJurnal && teacher && teacher.mapel && teacher.mapel.length > 0) {
        mapelJurnal.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
        teacher.mapel.forEach(mapel => {
          const option = document.createElement('option');
          option.value = mapel;
          option.textContent = mapel;
          mapelJurnal.appendChild(option);
        });
      } else if (mapelJurnal) {
        // Fallback for jurnal
        mapelJurnal.innerHTML = `
          <option value="">Pilih Mata Pelajaran</option>
          <option value="Matematika">Matematika</option>
          <option value="Bahasa Indonesia">Bahasa Indonesia</option>
        `;
      }

      // Populate Nilai form
      const guruNilai = document.getElementById('guruNilai');
      if (guruNilai && teacher) {
        guruNilai.innerHTML = `<option value="${teacher.nama}" selected>${teacher.nama}</option>`;
        guruNilai.disabled = true;
        guruNilai.style.backgroundColor = '#f5f5f5';
        guruNilai.style.cursor = 'not-allowed';
        guruNilai.classList.add('no-dropdown');
      }

      const kelasNilai = document.getElementById('kelasNilai');
      if (kelasNilai && teacher && teacher.kelas && teacher.kelas.length > 0) {
        kelasNilai.innerHTML = '<option value="">Pilih Kelas</option>';
        teacher.kelas.forEach(kelas => {
          const option = document.createElement('option');
          option.value = kelas;
          option.textContent = kelas;
          kelasNilai.appendChild(option);
        });
      } else if (kelasNilai) {
        // Fallback for nilai
        kelasNilai.innerHTML = `
          <option value="">Pilih Kelas</option>
          <option value="VII A">VII A</option>
          <option value="VII B">VII B</option>
        `;
      }

      const mapelNilai = document.getElementById('mapelNilai');
      if (mapelNilai && teacher && teacher.mapel && teacher.mapel.length > 0) {
        mapelNilai.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
        teacher.mapel.forEach(mapel => {
          const option = document.createElement('option');
          option.value = mapel;
          option.textContent = mapel;
          mapelNilai.appendChild(option);
        });
      } else if (mapelNilai) {
        // Fallback for nilai
        mapelNilai.innerHTML = `
          <option value="">Pilih Mata Pelajaran</option>
          <option value="Matematika">Matematika</option>
          <option value="Bahasa Indonesia">Bahasa Indonesia</option>
        `;
      }

      // For Rekap forms, show all classes and subjects for reports
      populateRekapForms();
    }

    function populateRekapForms() {
      // Populate attendance report form based on user role
      populateAttendanceReportForm();
      
      // Populate journal report form based on user role
      populateJournalReportForm();
      
      // Populate grades report form based on user role
      populateGradesReportForm();
    }

    function populateAttendanceReportForm() {
      if (!currentUser) return;
      
      console.log('Populating attendance report form for user:', currentUser);
      console.log('Current user role:', currentUser.role);
      console.log('Available teachers data:', teachersData);
      
      const kelasSelect = document.getElementById('kelasRekapAbsensi');
      const guruSelect = document.getElementById('guruRekapAbsensi');
      const mapelSelect = document.getElementById('mapelRekapAbsensi');
      
      if (currentUser.role === 'Guru') {
        // For regular teachers
        const teacher = teachersData[currentUser.username];
        
        if (teacher) {
          // Populate Kelas dropdown with teacher's classes + "Semua Kelas" option
          if (kelasSelect) {
            kelasSelect.innerHTML = '<option value="">Semua Kelas</option>';
            teacher.kelas.forEach(kelas => {
              if (kelas && kelas.trim()) {
                const option = document.createElement('option');
                option.value = kelas.trim();
                option.textContent = kelas.trim();
                kelasSelect.appendChild(option);
              }
            });
          }
          
          // Set Guru field to logged-in teacher (read-only, default value)
          if (guruSelect) {
            guruSelect.innerHTML = `<option value="${teacher.nama}" selected>${teacher.nama}</option>`;
            guruSelect.disabled = true;
            guruSelect.style.backgroundColor = '#f5f5f5';
            guruSelect.style.cursor = 'not-allowed';
            guruSelect.classList.add('no-dropdown');
          }
          
          // Populate Mata Pelajaran dropdown with teacher's subjects + "Semua Mapel" option
          if (mapelSelect) {
            mapelSelect.innerHTML = '<option value="">Semua Mapel</option>';
            teacher.mapel.forEach(mapel => {
              if (mapel && mapel.trim()) {
                const option = document.createElement('option');
                option.value = mapel.trim();
                option.textContent = mapel.trim();
                mapelSelect.appendChild(option);
              }
            });
          }
        } else {
          // Fallback if no teacher data found
          if (kelasSelect) {
            kelasSelect.innerHTML = '<option value="">Semua Kelas</option>';
          }
          if (guruSelect) {
            guruSelect.innerHTML = `<option value="${currentUser.name}" selected>${currentUser.name}</option>`;
            guruSelect.disabled = true;
            guruSelect.style.backgroundColor = '#f5f5f5';
            guruSelect.style.cursor = 'not-allowed';
            guruSelect.classList.add('no-dropdown');
          }
          if (mapelSelect) {
            mapelSelect.innerHTML = '<option value="">Semua Mapel</option>';
          }
        }
        
      } else if (currentUser.role.includes('Wali Kelas')) {
        // For homeroom teachers (Wali Kelas)
        console.log('Processing Wali Kelas role:', currentUser.role);
        const kelasFromRole = extractClassFromRole(currentUser.role);
        console.log('Extracted class from role:', kelasFromRole);
        
        // Populate Kelas dropdown with only their homeroom class (fixed, cannot be changed)
        if (kelasSelect && kelasFromRole) {
          kelasSelect.innerHTML = `<option value="${kelasFromRole}" selected>${kelasFromRole}</option>`;
          kelasSelect.disabled = true;
          kelasSelect.style.backgroundColor = '#f5f5f5';
          kelasSelect.style.cursor = 'not-allowed';
          console.log('Set class dropdown to:', kelasFromRole);
        }
        
        // Populate Guru dropdown with "Semua Guru" + all teachers who teach this class
        if (guruSelect && kelasFromRole) {
          console.log('Populating teachers for class:', kelasFromRole);
          populateTeachersForClass(guruSelect, kelasFromRole);
        }
        
        // Populate Mata Pelajaran dropdown with "Semua Mapel" + all subjects taught in this class
        if (mapelSelect && kelasFromRole) {
          console.log('Populating subjects for class:', kelasFromRole);
          populateSubjectsForClass(mapelSelect, kelasFromRole);
        }
        
      } else {
        // For administrators - show all options
        populateAllOptionsForAdmin();
      }
    }

    function extractClassFromRole(role) {
      console.log('Extracting class from role:', role);
      
      // Handle various role formats and match with actual class data
      let extractedClass = null;
      
      // Pattern 1: "Wali Kelas 7A" -> try to find matching class
      const match1 = role.match(/Wali Kelas (\d)([A-Z])/);
      if (match1) {
        const grade = match1[1];
        const section = match1[2];
        
        // Try different formats to match with actual data
        const possibleFormats = [
          `${grade}${section}`,           // "7A"
          `${grade} ${section}`,          // "7 A"
          `VII ${section}`,               // "VII A" (if grade is 7)
          `VIII ${section}`,              // "VIII A" (if grade is 8)
          `IX ${section}`                 // "IX A" (if grade is 9)
        ];
        
        // Check which format exists in our student data
        for (const format of possibleFormats) {
          if (studentsData[format]) {
            extractedClass = format;
            console.log('Found matching class format:', format);
            break;
          }
        }
      }
      
      // Pattern 2: "Wali Kelas VII A" -> direct match
      const match2 = role.match(/Wali Kelas (VII|VIII|IX) ([A-Z])/);
      if (match2 && !extractedClass) {
        const testClass = `${match2[1]} ${match2[2]}`;
        if (studentsData[testClass]) {
          extractedClass = testClass;
          console.log('Found direct class match:', testClass);
        }
      }
      
      // Pattern 3: "Wali Kelas" followed by any class format
      const match3 = role.match(/Wali Kelas (.+)/);
      if (match3 && !extractedClass) {
        const classStr = match3[1].trim();
        if (studentsData[classStr]) {
          extractedClass = classStr;
          console.log('Found exact class match:', classStr);
        }
      }
      
      // If still no match, try to find the closest match in available classes
      if (!extractedClass) {
        const availableClasses = Object.keys(studentsData);
        console.log('Available classes in data:', availableClasses);
        
        // Try to match based on grade and section
        const gradeMatch = role.match(/[789]|VII|VIII|IX/);
        const sectionMatch = role.match(/[A-Z]$/);
        
        if (gradeMatch && sectionMatch) {
          const grade = gradeMatch[0];
          const section = sectionMatch[0];
          
          // Look for any class that contains both grade and section
          for (const className of availableClasses) {
            if (className.includes(grade) && className.includes(section)) {
              extractedClass = className;
              console.log('Found approximate class match:', className);
              break;
            }
          }
        }
      }
      
      console.log('Final extracted class:', extractedClass);
      return extractedClass;
    }

    function populateJournalReportForm() {
      if (!currentUser) return;
      
      console.log('Populating journal report form for user:', currentUser);
      console.log('Current user role:', currentUser.role);
      
      const kelasSelect = document.getElementById('kelasRekapJurnal');
      const guruSelect = document.getElementById('guruRekapJurnal');
      const mapelSelect = document.getElementById('mapelRekapJurnal');
      
      if (currentUser.role === 'Administrator') {
        // Administrator can see all journals
        console.log('Administrator access - showing all options');
        
        // Populate all classes
        if (kelasSelect) {
          kelasSelect.innerHTML = '<option value="">Semua Kelas</option>';
          Object.keys(studentsData).sort().forEach(kelas => {
            const option = document.createElement('option');
            option.value = kelas;
            option.textContent = kelas;
            kelasSelect.appendChild(option);
          });
        }
        
        // Populate all teachers - Administrator can select any teacher
        if (guruSelect) {
          guruSelect.innerHTML = '<option value="">Semua Guru</option>';
          const allTeachers = new Set();
          Object.values(teachersData).forEach(teacher => {
            allTeachers.add(teacher.nama);
          });
          // Also add teachers from journal data
          journalReportData.forEach(record => {
            if (record.guru) {
              allTeachers.add(record.guru);
            }
          });
          Array.from(allTeachers).sort().forEach(guru => {
            const option = document.createElement('option');
            option.value = guru;
            option.textContent = guru;
            guruSelect.appendChild(option);
          });
          
          // Make sure dropdown is enabled for Administrator
          guruSelect.disabled = false;
          guruSelect.style.backgroundColor = '';
          guruSelect.style.cursor = '';
          console.log('Set guru dropdown as selectable for Administrator');
        }
        
        // Populate all subjects
        if (mapelSelect) {
          mapelSelect.innerHTML = '<option value="">Semua Mapel</option>';
          const allSubjects = new Set();
          Object.values(teachersData).forEach(teacher => {
            if (teacher.mapel) {
              teacher.mapel.forEach(mapel => {
                allSubjects.add(mapel);
              });
            }
          });
          // Also add subjects from journal data
          journalReportData.forEach(record => {
            if (record.mapel) {
              allSubjects.add(record.mapel);
            }
          });
          Array.from(allSubjects).sort().forEach(mapel => {
            const option = document.createElement('option');
            option.value = mapel;
            option.textContent = mapel;
            mapelSelect.appendChild(option);
          });
        }
        
      } else {
        // Regular teachers and Wali Kelas can only see their own journals
        console.log('Regular user access - limiting to own journals');
        
        const teacher = teachersData[currentUser.username];
        const currentUserName = currentUser.name;
        
        console.log('Teacher data:', teacher);
        console.log('Current user name:', currentUserName);
        
        // Set Guru field to logged-in teacher (read-only, default value)
        if (guruSelect) {
          guruSelect.innerHTML = `<option value="${currentUserName}" selected>${currentUserName}</option>`;
          guruSelect.disabled = true;
          guruSelect.style.backgroundColor = '#f5f5f5';
          guruSelect.style.cursor = 'not-allowed';
          guruSelect.classList.add('no-dropdown');
          console.log('Set guru dropdown to current user (read-only):', currentUserName);
        }
        
        // Populate classes based on teacher's classes or all classes if no specific data
        if (kelasSelect) {
          if (teacher && teacher.kelas && teacher.kelas.length > 0) {
            kelasSelect.innerHTML = '<option value="">Semua Kelas Saya</option>';
            teacher.kelas.forEach(kelas => {
              if (kelas && kelas.trim()) {
                const option = document.createElement('option');
                option.value = kelas.trim();
                option.textContent = kelas.trim();
                kelasSelect.appendChild(option);
              }
            });
            console.log('Populated classes for teacher:', teacher.kelas);
          } else {
            // If no teacher data, show classes from journal data for this teacher
            kelasSelect.innerHTML = '<option value="">Semua Kelas Saya</option>';
            const teacherClasses = new Set();
            journalReportData.forEach(record => {
              if (record.guru === currentUserName && record.kelas) {
                teacherClasses.add(record.kelas);
              }
            });
            Array.from(teacherClasses).sort().forEach(kelas => {
              const option = document.createElement('option');
              option.value = kelas;
              option.textContent = kelas;
              kelasSelect.appendChild(option);
            });
            console.log('Populated classes from journal data:', Array.from(teacherClasses));
          }
        }
        
        // Populate subjects based on teacher's subjects or all subjects if no specific data
        if (mapelSelect) {
          if (teacher && teacher.mapel && teacher.mapel.length > 0) {
            mapelSelect.innerHTML = '<option value="">Semua Mapel Saya</option>';
            teacher.mapel.forEach(mapel => {
              if (mapel && mapel.trim()) {
                const option = document.createElement('option');
                option.value = mapel.trim();
                option.textContent = mapel.trim();
                mapelSelect.appendChild(option);
              }
            });
            console.log('Populated subjects for teacher:', teacher.mapel);
          } else {
            // If no teacher data, show subjects from journal data for this teacher
            mapelSelect.innerHTML = '<option value="">Semua Mapel Saya</option>';
            const teacherSubjects = new Set();
            journalReportData.forEach(record => {
              if (record.guru === currentUserName && record.mapel) {
                teacherSubjects.add(record.mapel);
              }
            });
            Array.from(teacherSubjects).sort().forEach(mapel => {
              const option = document.createElement('option');
              option.value = mapel;
              option.textContent = mapel;
              mapelSelect.appendChild(option);
            });
            console.log('Populated subjects from journal data:', Array.from(teacherSubjects));
          }
        }
      }
    }

    function populateTeachersForClass(guruSelect, kelas) {
      console.log('populateTeachersForClass called with kelas:', kelas);
      console.log('Available teachersData:', teachersData);
      console.log('Available classes in studentsData:', Object.keys(studentsData));
      
      guruSelect.innerHTML = '<option value="">Semua Guru</option>';
      
      // Get unique teachers who teach this class from attendance data
      const teachersInClass = new Set();
      attendanceReportData.forEach(record => {
        if (record.kelas === kelas && record.guru) {
          teachersInClass.add(record.guru);
        }
      });
      console.log('Teachers from attendance data:', Array.from(teachersInClass));
      
      // Add teachers from teachersData who have this class
      // Try different matching strategies for class names
      Object.values(teachersData).forEach(teacher => {
        console.log('Checking teacher:', teacher.nama, 'classes:', teacher.kelas);
        
        if (teacher.kelas && Array.isArray(teacher.kelas)) {
          // Check for exact match first
          if (teacher.kelas.includes(kelas)) {
            teachersInClass.add(teacher.nama);
            console.log('Added teacher (exact match):', teacher.nama);
            return;
          }
          
          // Check for partial matches (e.g., "7A" matches "VII A")
          const kelasVariations = generateClassVariations(kelas);
          console.log('Class variations for', kelas, ':', kelasVariations);
          
          for (const variation of kelasVariations) {
            if (teacher.kelas.includes(variation)) {
              teachersInClass.add(teacher.nama);
              console.log('Added teacher (variation match):', teacher.nama, 'via', variation);
              break;
            }
          }
          
          // Also check if any of teacher's classes match our variations
          for (const teacherClass of teacher.kelas) {
            const teacherVariations = generateClassVariations(teacherClass);
            if (teacherVariations.includes(kelas)) {
              teachersInClass.add(teacher.nama);
              console.log('Added teacher (reverse match):', teacher.nama, 'class:', teacherClass);
              break;
            }
          }
        }
      });
      
      console.log('Final teachers for class', kelas, ':', Array.from(teachersInClass));
      
      // Sort and add to dropdown
      Array.from(teachersInClass).sort().forEach(guru => {
        const option = document.createElement('option');
        option.value = guru;
        option.textContent = guru;
        guruSelect.appendChild(option);
        console.log('Added teacher option:', guru);
      });
      
      // If no teachers found, add a fallback message
      if (teachersInClass.size === 0) {
        console.log('No teachers found for class, adding fallback');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Tidak ada guru ditemukan untuk kelas ini';
        option.disabled = true;
        guruSelect.appendChild(option);
      }
    }

    // Generate class name variations for matching
    function generateClassVariations(className) {
      if (!className) return [];
      
      const variations = [className]; // Include original
      
      // Handle "VII A" <-> "7A" conversions
      const romanToNumber = { 'VII': '7', 'VIII': '8', 'IX': '9' };
      const numberToRoman = { '7': 'VII', '8': 'VIII', '9': 'IX' };
      
      // Pattern: "VII A" -> ["7A", "7 A", "VIIA"]
      const romanMatch = className.match(/^(VII|VIII|IX)\s+([A-Z])$/);
      if (romanMatch) {
        const roman = romanMatch[1];
        const section = romanMatch[2];
        const number = romanToNumber[roman];
        
        variations.push(`${number}${section}`);      // "7A"
        variations.push(`${number} ${section}`);     // "7 A"
        variations.push(`${roman}${section}`);       // "VIIA"
      }
      
      // Pattern: "7A" -> ["VII A", "7 A", "VIIA"]
      const numberMatch = className.match(/^(\d)([A-Z])$/);
      if (numberMatch) {
        const number = numberMatch[1];
        const section = numberMatch[2];
        const roman = numberToRoman[number];
        
        if (roman) {
          variations.push(`${roman} ${section}`);    // "VII A"
          variations.push(`${roman}${section}`);     // "VIIA"
        }
        variations.push(`${number} ${section}`);     // "7 A"
      }
      
      // Pattern: "7 A" -> ["7A", "VII A", "VIIA"]
      const spaceMatch = className.match(/^(\d)\s+([A-Z])$/);
      if (spaceMatch) {
        const number = spaceMatch[1];
        const section = spaceMatch[2];
        const roman = numberToRoman[number];
        
        variations.push(`${number}${section}`);      // "7A"
        if (roman) {
          variations.push(`${roman} ${section}`);    // "VII A"
          variations.push(`${roman}${section}`);     // "VIIA"
        }
      }
      
      // Remove duplicates
      return [...new Set(variations)];
    }

    function populateSubjectsForClass(mapelSelect, kelas) {
      console.log('populateSubjectsForClass called with kelas:', kelas);
      
      mapelSelect.innerHTML = '<option value="">Semua Mapel</option>';
      
      // Get unique subjects taught in this class from attendance data
      const subjectsInClass = new Set();
      attendanceReportData.forEach(record => {
        if (record.kelas === kelas && record.mapel) {
          subjectsInClass.add(record.mapel);
        }
      });
      console.log('Subjects from attendance data:', Array.from(subjectsInClass));
      
      // Add subjects from teachersData for teachers who teach this class
      // Try different matching strategies for class names
      Object.values(teachersData).forEach(teacher => {
        console.log('Checking teacher:', teacher.nama, 'classes:', teacher.kelas, 'subjects:', teacher.mapel);
        
        if (teacher.kelas && Array.isArray(teacher.kelas) && teacher.mapel && Array.isArray(teacher.mapel)) {
          let teacherTeachesThisClass = false;
          
          // Check for exact match first
          if (teacher.kelas.includes(kelas)) {
            teacherTeachesThisClass = true;
          } else {
            // Check for variations
            const kelasVariations = generateClassVariations(kelas);
            console.log('Class variations for', kelas, ':', kelasVariations);
            
            for (const variation of kelasVariations) {
              if (teacher.kelas.includes(variation)) {
                teacherTeachesThisClass = true;
                console.log('Teacher teaches class via variation:', teacher.nama, variation);
                break;
              }
            }
            
            // Also check reverse - if any teacher class matches our variations
            if (!teacherTeachesThisClass) {
              for (const teacherClass of teacher.kelas) {
                const teacherVariations = generateClassVariations(teacherClass);
                if (teacherVariations.includes(kelas)) {
                  teacherTeachesThisClass = true;
                  console.log('Teacher teaches class via reverse match:', teacher.nama, teacherClass);
                  break;
                }
              }
            }
          }
          
          if (teacherTeachesThisClass) {
            teacher.mapel.forEach(mapel => {
              subjectsInClass.add(mapel);
              console.log('Added subject to class:', mapel, 'from teacher:', teacher.nama);
            });
          }
        }
      });
      
      console.log('Final subjects for class', kelas, ':', Array.from(subjectsInClass));
      
      // Sort and add to dropdown
      Array.from(subjectsInClass).sort().forEach(mapel => {
        const option = document.createElement('option');
        option.value = mapel;
        option.textContent = mapel;
        mapelSelect.appendChild(option);
        console.log('Added subject option:', mapel);
      });
      
      // If no subjects found, add a fallback message
      if (subjectsInClass.size === 0) {
        console.log('No subjects found for class, adding fallback');
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Tidak ada mata pelajaran ditemukan untuk kelas ini';
        option.disabled = true;
        mapelSelect.appendChild(option);
      }
    }

    function populateAllSubjectsForClass(mapelSelect, kelas) {
      console.log('populateAllSubjectsForClass called with kelas:', kelas);
      
      mapelSelect.innerHTML = '<option value="">Semua Mapel</option>';
      
      // Get unique subjects taught in this class from grades data
      const subjectsInClass = new Set();
      gradesReportData.forEach(record => {
        if (record.kelas === kelas && record.mapel) {
          subjectsInClass.add(record.mapel);
        }
      });
      console.log('Subjects from grades data:', Array.from(subjectsInClass));
      
      // Also get subjects from attendance data
      attendanceReportData.forEach(record => {
        if (record.kelas === kelas && record.mapel) {
          subjectsInClass.add(record.mapel);
        }
      });
      console.log('Subjects from attendance data:', Array.from(subjectsInClass));
      
      // Add subjects from teachersData for teachers who teach this class
      Object.values(teachersData).forEach(teacher => {
        console.log('Checking teacher:', teacher.nama, 'classes:', teacher.kelas, 'subjects:', teacher.mapel);
        
        if (teacher.kelas && Array.isArray(teacher.kelas) && teacher.mapel && Array.isArray(teacher.mapel)) {
          let teacherTeachesThisClass = false;
          
          // Check for exact match first
          if (teacher.kelas.includes(kelas)) {
            teacherTeachesThisClass = true;
          } else {
            // Check for variations
            const kelasVariations = generateClassVariations(kelas);
            console.log('Class variations for', kelas, ':', kelasVariations);
            
            for (const variation of kelasVariations) {
              if (teacher.kelas.includes(variation)) {
                teacherTeachesThisClass = true;
                console.log('Teacher teaches class via variation:', teacher.nama, variation);
                break;
              }
            }
            
            // Also check reverse - if any teacher class matches our variations
            if (!teacherTeachesThisClass) {
              for (const teacherClass of teacher.kelas) {
                const teacherVariations = generateClassVariations(teacherClass);
                if (teacherVariations.includes(kelas)) {
                  teacherTeachesThisClass = true;
                  console.log('Teacher teaches class via reverse match:', teacher.nama, teacherClass);
                  break;
                }
              }
            }
          }
          
          if (teacherTeachesThisClass) {
            teacher.mapel.forEach(mapel => {
              subjectsInClass.add(mapel);
              console.log('Added subject to class:', mapel, 'from teacher:', teacher.nama);
            });
          }
        }
      });
      
      console.log('Final subjects for homeroom class', kelas, ':', Array.from(subjectsInClass));
      
      // Sort and add to dropdown
      Array.from(subjectsInClass).sort().forEach(mapel => {
        const option = document.createElement('option');
        option.value = mapel;
        option.textContent = mapel;
        mapelSelect.appendChild(option);
        console.log('Added subject option:', mapel);
      });
      
      // If no subjects found, add standard subjects as fallback
      if (subjectsInClass.size === 0) {
        console.log('No subjects found for class, adding standard subjects');
        const standardSubjects = [
          'Pendidikan Agama Islam',
          'Matematika',
          'Bahasa Indonesia',
          'Bahasa Inggris',
          'IPA',
          'IPS',
          'Seni Budaya',
          'Pendidikan Jasmani',
          'Prakarya'
        ];
        
        standardSubjects.forEach(mapel => {
          const option = document.createElement('option');
          option.value = mapel;
          option.textContent = mapel;
          mapelSelect.appendChild(option);
        });
      }
    }

    function populateGradesReportForm() {
      if (!currentUser) return;
      
      console.log('Populating grades report form for user:', currentUser);
      console.log('Current user role:', currentUser.role);
      
      const kelasSelect = document.getElementById('kelasRekapNilai');
      const mapelSelect = document.getElementById('mapelRekapNilai');
      
      if (currentUser.role === 'Administrator') {
        // Administrator can see all grades
        console.log('Administrator access - showing all options for grades');
        
        // Populate all classes
        if (kelasSelect) {
          kelasSelect.innerHTML = '<option value="">Semua Kelas</option>';
          Object.keys(studentsData).sort().forEach(kelas => {
            const option = document.createElement('option');
            option.value = kelas;
            option.textContent = kelas;
            kelasSelect.appendChild(option);
          });
        }
        

        
        // Populate all subjects
        if (mapelSelect) {
          mapelSelect.innerHTML = '<option value="">Semua Mapel</option>';
          const allSubjects = new Set();
          Object.values(teachersData).forEach(teacher => {
            if (teacher.mapel) {
              teacher.mapel.forEach(mapel => {
                allSubjects.add(mapel);
              });
            }
          });
          Array.from(allSubjects).sort().forEach(mapel => {
            const option = document.createElement('option');
            option.value = mapel;
            option.textContent = mapel;
            mapelSelect.appendChild(option);
          });
        }
        
      } else if (currentUser.role.includes('Wali Kelas')) {
        // Wali Kelas can see all grades for their homeroom class
        console.log('Wali Kelas access - showing all subjects for homeroom class');
        
        const kelasFromRole = extractClassFromRole(currentUser.role);
        console.log('Extracted homeroom class:', kelasFromRole);
        
        // Set Kelas field to homeroom class (read-only, fixed)
        if (kelasSelect && kelasFromRole) {
          kelasSelect.innerHTML = `<option value="${kelasFromRole}" selected>${kelasFromRole}</option>`;
          kelasSelect.disabled = true;
          kelasSelect.style.backgroundColor = '#f5f5f5';
          kelasSelect.style.cursor = 'not-allowed';
          console.log('Set class dropdown to homeroom class:', kelasFromRole);
        }
        

        
        // Populate all subjects taught in this class
        if (mapelSelect && kelasFromRole) {
          console.log('Populating all subjects for homeroom class:', kelasFromRole);
          populateAllSubjectsForClass(mapelSelect, kelasFromRole);
        }
        
      } else {
        // Regular teachers can only see their own grades
        console.log('Regular teacher access - limiting to own grades');
        
        const teacher = teachersData[currentUser.username];
        const currentUserName = currentUser.name;
        
        console.log('Teacher data:', teacher);
        console.log('Current user name:', currentUserName);
        

        
        // Populate classes based on teacher's classes
        if (kelasSelect) {
          if (teacher && teacher.kelas && teacher.kelas.length > 0) {
            kelasSelect.innerHTML = '<option value="">Semua Kelas Saya</option>';
            teacher.kelas.forEach(kelas => {
              if (kelas && kelas.trim()) {
                const option = document.createElement('option');
                option.value = kelas.trim();
                option.textContent = kelas.trim();
                kelasSelect.appendChild(option);
              }
            });
            console.log('Populated classes for teacher:', teacher.kelas);
          } else {
            // If no teacher data, show limited fallback
            kelasSelect.innerHTML = '<option value="">Semua Kelas Saya</option>';
            console.log('No teacher classes found, using fallback');
          }
        }
        
        // Populate subjects based on teacher's subjects
        if (mapelSelect) {
          if (teacher && teacher.mapel && teacher.mapel.length > 0) {
            mapelSelect.innerHTML = '<option value="">Semua Mapel Saya</option>';
            teacher.mapel.forEach(mapel => {
              if (mapel && mapel.trim()) {
                const option = document.createElement('option');
                option.value = mapel.trim();
                option.textContent = mapel.trim();
                mapelSelect.appendChild(option);
              }
            });
            console.log('Populated subjects for teacher:', teacher.mapel);
          } else {
            // If no teacher data, show limited fallback
            mapelSelect.innerHTML = '<option value="">Semua Mapel Saya</option>';
            console.log('No teacher subjects found, using fallback');
          }
        }
      }
    }

    function populateAllOptionsForAdmin() {
      const kelasSelect = document.getElementById('kelasRekapAbsensi');
      const guruSelect = document.getElementById('guruRekapAbsensi');
      const mapelSelect = document.getElementById('mapelRekapAbsensi');
      
      // Populate all classes
      if (kelasSelect) {
        kelasSelect.innerHTML = '<option value="">Semua Kelas</option>';
        Object.keys(studentsData).sort().forEach(kelas => {
          const option = document.createElement('option');
          option.value = kelas;
          option.textContent = kelas;
          kelasSelect.appendChild(option);
        });
      }
      
      // Populate all teachers
      if (guruSelect) {
        guruSelect.innerHTML = '<option value="">Semua Guru</option>';
        const allTeachers = new Set();
        Object.values(teachersData).forEach(teacher => {
          allTeachers.add(teacher.nama);
        });
        Array.from(allTeachers).sort().forEach(guru => {
          const option = document.createElement('option');
          option.value = guru;
          option.textContent = guru;
          guruSelect.appendChild(option);
        });
      }
      
      // Populate all subjects
      if (mapelSelect) {
        mapelSelect.innerHTML = '<option value="">Semua Mapel</option>';
        const allSubjects = new Set();
        Object.values(teachersData).forEach(teacher => {
          if (teacher.mapel) {
            teacher.mapel.forEach(mapel => {
              allSubjects.add(mapel);
            });
          }
        });
        Array.from(allSubjects).sort().forEach(mapel => {
          const option = document.createElement('option');
          option.value = mapel;
          option.textContent = mapel;
          mapelSelect.appendChild(option);
        });
      }
    }

    // Populate class dropdowns with available classes (fallback function)
    function populateClassDropdowns() {
      const classSelects = [
        'kelasAbsensi',
        'kelasNilai',
        'kelasJurnal',
        'kelasRekapAbsensi',
        'kelasRekapJurnal',
        'kelasRekapNilai'
      ];
      
      classSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          // Keep the first option (Pilih Kelas / Semua Kelas)
          const firstOption = select.options[0];
          select.innerHTML = '';
          select.appendChild(firstOption);
          
          // Add available classes
          Object.keys(studentsData).sort().forEach(kelas => {
            const option = document.createElement('option');
            option.value = kelas;
            option.textContent = kelas;
            select.appendChild(option);
          });
        }
      });
    }

    // Set default date range for report pages
    function setDefaultDateRange() {
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      const todayStr = today.toISOString().split('T')[0];
      const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().split('T')[0];
      
      // Set for journal report
      const tanggalAwalJurnal = document.getElementById('tanggalAwalJurnal');
      const tanggalAkhirJurnal = document.getElementById('tanggalAkhirJurnal');
      
      if (tanggalAwalJurnal) tanggalAwalJurnal.value = thirtyDaysAgoStr;
      if (tanggalAkhirJurnal) tanggalAkhirJurnal.value = todayStr;
      
      // Set for attendance report
      const tanggalAwalAbsensi = document.getElementById('tanggalAwalAbsensi');
      const tanggalAkhirAbsensi = document.getElementById('tanggalAkhirAbsensi');
      
      if (tanggalAwalAbsensi) tanggalAwalAbsensi.value = thirtyDaysAgoStr;
      if (tanggalAkhirAbsensi) tanggalAkhirAbsensi.value = todayStr;
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      // Load user data from Google Sheets
      loadUsersFromGoogleSheets();
      
      // Load teacher data from Google Sheets
      loadTeachersFromGoogleSheets();
      
      // Load student data from Google Sheets and populate dropdowns
      loadStudentsFromGoogleSheets();
      
      // Load attendance report data
      loadAttendanceReportData();
      
      // Load journal report data
      loadJournalReportData();
      
      // Load grades report data
      loadGradesReportData();
      
      // Set today's date for all date inputs (except report date ranges)
      const today = new Date().toISOString().split('T')[0];
      const dateInputs = document.querySelectorAll('input[type="date"]');
      dateInputs.forEach(input => {
        // Skip report date range inputs - they will be set by setDefaultDateRange()
        if (!input.id.includes('tanggalAwal') && !input.id.includes('tanggalAkhir')) {
          input.value = today;
        }
      });

      // Set today's date specifically for form inputs when pages are shown
      const formDateInputs = ['tanggalAbsensi', 'tanggalJurnal'];
      formDateInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.value = today;
        }
      });

      // Set default date ranges for reports
      setDefaultDateRange();

      // Update datetime
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // Add username input listener
      document.getElementById('username').addEventListener('input', updateRoleCards);

      // Login form handler
      document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        login();
      });
    });

    function updateDateTime() {
      const now = new Date();
      const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      };
      const dateTimeStr = now.toLocaleDateString('id-ID', options);
      document.getElementById('currentDateTime').textContent = dateTimeStr;
    }

    function selectRole(roleName) {
      // Remove active class from all role cards
      const roleCards = document.querySelectorAll('.role-card');
      roleCards.forEach(card => card.classList.remove('active'));
      
      // Add active class to selected card
      event.target.closest('.role-card').classList.add('active');
      
      // Update radio button
      const radioButtons = document.querySelectorAll('input[name="role"]');
      radioButtons.forEach(radio => {
        radio.checked = radio.value === roleName;
      });
    }

    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const role = document.querySelector('input[name="role"]:checked')?.value;

      if (!username || !password || !role) {
        alert('Harap lengkapi semua field!');
        return;
      }

      // Check if user data is loaded
      if (Object.keys(usersData).length === 0) {
        alert('Data pengguna belum dimuat. Silakan tunggu sebentar dan coba lagi.');
        loadUsersFromGoogleSheets();
        return;
      }

      const user = usersData[username];
      if (!user || user.password !== password) {
        alert('Username atau password salah!');
        return;
      }

      // Check if user has the selected role
      if (!user.roles.includes(role)) {
        alert(`Anda tidak memiliki akses sebagai ${role}. Role yang tersedia: ${user.roles.join(', ')}`);
        return;
      }

      currentUser = {
        username: username,
        name: user.name,
        role: role,
        availableRoles: user.roles
      };

      // Hide login page and show main app
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';

      // Update user info
      document.getElementById('userInfo').textContent = `${currentUser.name} (${currentUser.role})`;
      document.getElementById('greetingText').textContent = `Selamat Datang, ${currentUser.name}!`;

      // Update menu based on role
      updateMenuForRole(currentUser.role);

      // Populate forms based on logged-in teacher (with delay to ensure data is loaded)
      setTimeout(() => {
        console.log('About to populate teacher forms for user:', currentUser.username);
        console.log('Available teachers data:', Object.keys(teachersData));
        populateTeacherForms();
      }, 500);

      // Show dashboard
      showPage('dashboard');
    }

    function updateMenuForRole(role) {
      const menuGrid = document.getElementById('menuGrid');
      const bottomNav = document.getElementById('bottomNav');
      
      console.log('Updating menu for role:', role); // Debug log
      
      // Check if role is Administrator
      if (role === 'Administrator') {
        // Show only Rekap menus for Administrator
        menuGrid.innerHTML = `
          <div class="menu-card" onclick="showPage('rekapAbsensi')">
            <div class="menu-icon" style="background: #9C27B0;">üìä</div>
            <h3>Rekap Absensi</h3>
            <p>Laporan kehadiran siswa dalam rentang waktu</p>
          </div>
          
          <div class="menu-card" onclick="showPage('rekapJurnal')">
            <div class="menu-icon" style="background: #607D8B;">üìã</div>
            <h3>Rekap Jurnal</h3>
            <p>Laporan kegiatan pembelajaran</p>
          </div>
          
          <div class="menu-card" onclick="showPage('rekapNilai')">
            <div class="menu-icon" style="background: #795548;">üéØ</div>
            <h3>Rekap Nilai</h3>
            <p>Laporan nilai siswa per mata pelajaran</p>
          </div>
          

        `;
        
        // Update bottom navigation for Administrator - Dashboard and all Rekap menus
        bottomNav.innerHTML = `
          <div class="nav-item active" onclick="showPage('dashboard')">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">Dashboard</div>
          </div>
          <div class="nav-item" onclick="showPage('rekapAbsensi')">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Rekap Absensi</div>
          </div>
          <div class="nav-item" onclick="showPage('rekapJurnal')">
            <div class="nav-icon">üìã</div>
            <div class="nav-label">Rekap Jurnal</div>
          </div>
          <div class="nav-item" onclick="showPage('rekapNilai')">
            <div class="nav-icon">üéØ</div>
            <div class="nav-label">Rekap Nilai</div>
          </div>
        `;
        
        console.log('Menu updated for Administrator - rekap menus only'); // Debug log
      } else if (role === 'Wali Kelas' || role.includes('Wali Kelas')) {
        // Show only Rekap Absensi and Rekap Nilai for Wali Kelas
        menuGrid.innerHTML = `
          <div class="menu-card" onclick="showPage('rekapAbsensi')">
            <div class="menu-icon" style="background: #9C27B0;">üìä</div>
            <h3>Rekap Absensi</h3>
            <p>Laporan kehadiran siswa dalam rentang waktu</p>
          </div>
          
          <div class="menu-card" onclick="showPage('rekapNilai')">
            <div class="menu-icon" style="background: #795548;">üéØ</div>
            <h3>Rekap Nilai</h3>
            <p>Laporan nilai siswa per mata pelajaran</p>
          </div>
          

        `;
        
        // Update bottom navigation for Wali Kelas - only Dashboard, Rekap Absensi, and Rekap Nilai
        bottomNav.innerHTML = `
          <div class="nav-item active" onclick="showPage('dashboard')">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">Dashboard</div>
          </div>
          <div class="nav-item" onclick="showPage('rekapAbsensi')">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Rekap Absensi</div>
          </div>
          <div class="nav-item" onclick="showPage('rekapNilai')">
            <div class="nav-icon">üéØ</div>
            <div class="nav-label">Rekap Nilai</div>
          </div>
        `;
        
        console.log('Menu updated for Wali Kelas - limited menu'); // Debug log
      } else {
        // Show all menus for other roles (Guru, etc.)
        menuGrid.innerHTML = `
          <div class="menu-card" onclick="showPage('absensi')">
            <div class="menu-icon" style="background: #4CAF50;">üìù</div>
            <h3>Absensi Siswa</h3>
            <p>Input kehadiran siswa per kelas dan mata pelajaran</p>
          </div>
          
          <div class="menu-card" onclick="showPage('jurnal')">
            <div class="menu-icon" style="background: #2196F3;">üìñ</div>
            <h3>Jurnal Mengajar</h3>
            <p>Catat kegiatan pembelajaran harian</p>
          </div>
          
          <div class="menu-card" onclick="showPage('nilai')">
            <div class="menu-icon" style="background: #FF9800;">‚≠ê</div>
            <h3>Input Nilai</h3>
            <p>Input nilai siswa berdasarkan jenis penilaian</p>
          </div>
          
          <div class="menu-card" onclick="showPage('rekapAbsensi')">
            <div class="menu-icon" style="background: #9C27B0;">üìä</div>
            <h3>Rekap Absensi</h3>
            <p>Laporan kehadiran siswa dalam rentang waktu</p>
          </div>
          
          <div class="menu-card" onclick="showPage('rekapJurnal')">
            <div class="menu-icon" style="background: #607D8B;">üìã</div>
            <h3>Rekap Jurnal</h3>
            <p>Laporan kegiatan pembelajaran</p>
          </div>
          
          <div class="menu-card" onclick="showPage('rekapNilai')">
            <div class="menu-icon" style="background: #795548;">üéØ</div>
            <h3>Rekap Nilai</h3>
            <p>Laporan nilai siswa per mata pelajaran</p>
          </div>
          

        `;
        
        // Restore full bottom navigation
        bottomNav.innerHTML = `
          <div class="nav-item active" onclick="showPage('dashboard')">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">Dashboard</div>
          </div>
          <div class="nav-item" onclick="showPage('absensi')">
            <div class="nav-icon">üìù</div>
            <div class="nav-label">Absensi</div>
          </div>
          <div class="nav-item" onclick="showPage('jurnal')">
            <div class="nav-icon">üìñ</div>
            <div class="nav-label">Jurnal</div>
          </div>
          <div class="nav-item" onclick="showPage('nilai')">
            <div class="nav-icon">‚≠ê</div>
            <div class="nav-label">Nilai</div>
          </div>
          <div class="nav-item" onclick="toggleDropup(event)">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Rekap</div>
            <div class="dropup-menu" id="rekapDropup">
              <div class="dropup-item" onclick="selectRekapPage('rekapAbsensi')">
                <div class="dropup-item-icon">üìä</div>
                <div class="dropup-item-text">Rekap Absensi</div>
              </div>
              <div class="dropup-item" onclick="selectRekapPage('rekapJurnal')">
                <div class="dropup-item-icon">üìã</div>
                <div class="dropup-item-text">Rekap Jurnal</div>
              </div>
              <div class="dropup-item" onclick="selectRekapPage('rekapNilai')">
                <div class="dropup-item-icon">üéØ</div>
                <div class="dropup-item-text">Rekap Nilai</div>
              </div>
            </div>
          </div>

        `;
        
        console.log('Menu updated for role:', role, '- full menu'); // Debug log
      }
    }

    function logout() {
      currentUser = null;
      
      // Hide main app and show login page
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('loginPage').style.display = 'flex';
      
      // Reset login form
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      
      // Reset role to Guru (default)
      const roleCards = document.querySelectorAll('.role-card');
      roleCards.forEach((card, index) => {
        card.classList.remove('active');
        if (index === 1) card.classList.add('active'); // Guru card
      });
      
      const radioButtons = document.querySelectorAll('input[name="role"]');
      radioButtons.forEach((radio, index) => {
        radio.checked = index === 1; // Guru radio
      });
      
      // Reset pages
      const pageContents = document.querySelectorAll('.page-content');
      pageContents.forEach(content => content.classList.remove('active'));
      document.getElementById('dashboardContent').classList.add('active');
      
      // Reset navigation
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach((item, index) => {
        item.classList.remove('active');
        if (index === 0) item.classList.add('active'); // Dashboard
      });
      
      currentPage = 'dashboard';
    }

    function showPage(page) {
      // Hide all page contents
      const pageContents = document.querySelectorAll('.page-content');
      pageContents.forEach(content => {
        content.classList.remove('active');
      });

      // Remove active class from all nav items
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.classList.remove('active');
      });

      // Show selected page
      let targetPage = page;
      if (page === 'rekap') {
        targetPage = 'rekapAbsensi'; // Default to attendance report
      }

      const targetContent = document.getElementById(targetPage + 'Content');
      if (targetContent) {
        targetContent.classList.add('active');
      }



      // Populate forms when showing specific pages
      if (targetPage === 'absensi' || targetPage === 'jurnal' || targetPage === 'nilai') {
        setTimeout(() => {
          console.log('Populating forms for page:', targetPage);
          populateTeacherForms();
          
          // Set today's date for form inputs
          const today = new Date().toISOString().split('T')[0];
          if (targetPage === 'absensi') {
            const tanggalAbsensi = document.getElementById('tanggalAbsensi');
            if (tanggalAbsensi) tanggalAbsensi.value = today;
          }
          if (targetPage === 'jurnal') {
            const tanggalJurnal = document.getElementById('tanggalJurnal');
            if (tanggalJurnal) tanggalJurnal.value = today;
          }
          
          // Force re-populate absensi form if on absensi page
          if (targetPage === 'absensi') {
            setTimeout(() => {
              const teacher = currentUser && teachersData[currentUser.username] ? teachersData[currentUser.username] : null;
              console.log('Re-populating absensi form with teacher data:', teacher);
              populateAbsensiForm(teacher);
            }, 200);
          }
        }, 100);
      }

      // Auto-load data when showing attendance report page
      if (targetPage === 'rekapAbsensi') {
        setTimeout(() => {
          console.log('Loading attendance report page');
          populateAttendanceReportForm();
          
          // Set default date range (30 days ago to today)
          setDefaultDateRange();
          
          // Show initial loading message without auto-filtering
          const tableBody = document.getElementById('attendanceReportTable');
          tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #666; padding: 20px;"><div class="loading-indicator">Klik "Filter Data" untuk menampilkan absensi</div></td></tr>';
        }, 300);
      }

      // Auto-load data when showing journal report page
      if (targetPage === 'rekapJurnal') {
        setTimeout(() => {
          console.log('Loading journal report page');
          populateJournalReportForm();
          
          // Set default date range (30 days ago to today)
          setDefaultDateRange();
          
          // Show initial loading message without auto-filtering
          const tableBody = document.getElementById('journalReportTable');
          tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;"><div class="loading-indicator">Klik "Filter Data" untuk menampilkan jurnal</div></td></tr>';
        }, 300);
      }

      // Auto-load data when showing grades report page
      if (targetPage === 'rekapNilai') {
        setTimeout(() => {
          console.log('Loading grades report page');
          populateGradesReportForm();
          
          // Show initial loading message without auto-filtering
          const tableBody = document.getElementById('gradesReportTable');
          tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666; padding: 20px;"><div class="loading-indicator">Klik "Filter Data" untuk menampilkan nilai</div></td></tr>';
        }, 300);
      }

      // Update active nav item
      const navLabels = {
        'dashboard': 'Dashboard',
        'absensi': 'Absensi',
        'jurnal': 'Jurnal',
        'nilai': 'Nilai',
        'rekapAbsensi': 'Rekap',
        'rekapJurnal': 'Rekap',
        'rekapNilai': 'Rekap'
      };

      navItems.forEach(item => {
        const label = item.querySelector('.nav-label').textContent;
        if (label === navLabels[targetPage]) {
          item.classList.add('active');
        }
      });

      currentPage = targetPage;
    }

    function loadStudents() {
      const kelas = document.getElementById('kelasAbsensi').value;
      const tanggal = document.getElementById('tanggalAbsensi').value;
      const jam = document.getElementById('jamAbsensi').value;
      const studentListContainer = document.getElementById('studentList');

      if (!kelas) {
        studentListContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Pilih kelas terlebih dahulu</p>';
        return;
      }

      if (!tanggal || !jam) {
        studentListContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Pilih tanggal dan jam terlebih dahulu</p>';
        return;
      }

      // Check for duplicate attendance entry
      const isDuplicate = attendanceReportData.some(record => {
        return record.kelas === kelas && 
               record.tanggal === tanggal && 
               record.jam === jam;
      });

      if (isDuplicate) {
        studentListContainer.innerHTML = `
          <div style="text-align: center; padding: 30px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; margin: 10px 0;">
            <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
            <h3 style="color: #856404; margin: 0 0 10px 0;">Absensi Sudah Diisi!</h3>
            <p style="color: #856404; margin: 0; font-size: 14px; line-height: 1.5;">
              Absensi untuk <strong>Kelas ${kelas}</strong> pada tanggal <strong>${formatDate(tanggal)}</strong> 
              dan <strong>${jam}</strong> sudah pernah diinput sebelumnya.
            </p>
            <p style="color: #856404; margin: 10px 0 0 0; font-size: 13px; font-style: italic;">
              Silakan pilih kelas, tanggal, atau jam yang berbeda.
            </p>
          </div>
        `;
        return;
      }

      const students = studentsData[kelas] || [];
      
      const studentListHTML = students.map((student, index) => `
        <div class="student-item" style="padding: 10px 15px;">
          <div class="student-info">
            <div class="student-number" style="font-size: 12px;">${index + 1}</div>
            <div class="student-name" style="font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">${student.nama}</div>
          </div>
          <div class="attendance-options" style="display: flex; align-items: center; gap: 8px;">
            <select class="attendance-dropdown" data-nis="${student.nis}" onchange="selectAttendanceDropdown(this)" style="font-size: 12px; min-width: 90px; max-width: 100px;">
              <option value="Hadir" selected>Hadir</option>
              <option value="Sakit">Sakit</option>
              <option value="Izin">Izin</option>
              <option value="Alpha">Alpha</option>
            </select>
          </div>
        </div>
      `).join('');

      studentListContainer.innerHTML = studentListHTML;
    }



    function selectAttendance(button, status) {
      // Remove active class from all buttons in the same row
      const studentItem = button.closest('.student-item');
      const allButtons = studentItem.querySelectorAll('.attendance-btn');
      allButtons.forEach(btn => btn.classList.remove('active'));
      
      // Add active class to selected button
      button.classList.add('active');
    }

    function selectAttendanceDropdown(dropdown) {
      // Update dropdown styling based on selection
      const value = dropdown.value;
      dropdown.className = `attendance-dropdown ${value.toLowerCase()}`;
    }

    function setAllAttendance(status) {
      const allDropdowns = document.querySelectorAll('.attendance-dropdown');
      allDropdowns.forEach(dropdown => {
        // Set the correct value based on the status parameter
        let dropdownValue = '';
        switch(status.toLowerCase()) {
          case 'hadir':
            dropdownValue = 'Hadir';
            break;
          case 'sakit':
            dropdownValue = 'Sakit';
            break;
          case 'izin':
            dropdownValue = 'Izin';
            break;
          case 'alpha':
            dropdownValue = 'Alpha';
            break;
          default:
            dropdownValue = 'Hadir';
        }
        
        // Set the dropdown value
        dropdown.value = dropdownValue;
        
        // Update the dropdown styling
        dropdown.className = `attendance-dropdown ${status.toLowerCase()}`;
      });
    }



    async function saveAttendance() {
      const kelas = document.getElementById('kelasAbsensi').value;
      const guru = document.getElementById('guruAbsensi').value;
      const mapel = document.getElementById('mapelAbsensi').value;
      const jam = document.getElementById('jamAbsensi').value;
      const tanggal = document.getElementById('tanggalAbsensi').value;

      if (!kelas || !guru || !mapel || !jam || !tanggal) {
        alert('Harap lengkapi semua field!');
        return;
      }

      // Check for duplicate attendance entry
      const isDuplicate = attendanceReportData.some(record => {
        return record.kelas === kelas && 
               record.tanggal === tanggal && 
               record.jam === jam;
      });

      if (isDuplicate) {
        alert(`‚ùå Absensi di kelas ${kelas} pada tanggal ${formatDate(tanggal)} dan ${jam} sudah di input!\n\nSilakan pilih kelas, tanggal, atau jam yang berbeda.`);
        return;
      }

      // Collect attendance data
      const attendanceData = [];
      const studentItems = document.querySelectorAll('.student-item');
      
      studentItems.forEach(item => {
        const studentName = item.querySelector('.student-name').textContent;
        const dropdown = item.querySelector('.attendance-dropdown');
        const status = dropdown ? dropdown.value : 'Hadir';
        
        // Find student data to get NIS and gender
        const students = studentsData[kelas] || [];
        const student = students.find(s => s.nama === studentName);
        
        attendanceData.push({
          nis: student ? student.nis : '',
          nama: studentName,
          lp: student ? student.lp : 'L',
          status: status
        });
      });

      if (attendanceData.length === 0) {
        alert('Tidak ada data siswa untuk disimpan!');
        return;
      }

      // Show progress dialog
      const progressDialog = createProgressDialog(attendanceData.length);
      document.body.appendChild(progressDialog);

      const scriptUrl = 'https://script.google.com/macros/s/AKfycbzILDROC_P1dwSFNbrZwCDgfm8mms-l9qEjFYS5wUH4SP2TrE9uJMq6s3viCbJV57_v/exec';
      const currentTime = new Date().toLocaleTimeString('id-ID');
      
      let successCount = 0;
      let failCount = 0;

      // Save each student's attendance
      for (let i = 0; i < attendanceData.length; i++) {
        const student = attendanceData[i];
        
        // Update progress
        updateProgress(i + 1, attendanceData.length);
        
        try {
          const formData = new FormData();
          
          formData.append('mode', 'insert');
          formData.append('tanggalAbsen', tanggal);
          formData.append('Waktu', currentTime);
          formData.append('nis', student.nis);
          formData.append('namaLengkap', student.nama);
          formData.append('jenisKelamin', student.lp);
          formData.append('kelas', kelas);
          formData.append('jamKe', jam);
          formData.append('mataPelajaran', mapel);
          formData.append('status', student.status);
          formData.append('keterangan', '');
          formData.append('guru', guru);

          console.log('Sending attendance data for:', student.nama, 'Status:', student.status);

          const response = await fetch(scriptUrl, {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log('Response for student', student.nama, ':', result);
          
          if (result.status === 'sukses') {
            successCount++;
          } else {
            failCount++;
            console.error('Error saving student:', student.nama, result.pesan);
          }
        } catch (error) {
          failCount++;
          console.error('Network error for student:', student.nama, error);
        }

        // Small delay to show progress
        await new Promise(resolve => setTimeout(resolve, 300));
      }

      // Remove progress dialog
      document.body.removeChild(progressDialog);

      // Show result
      if (successCount === attendanceData.length) {
        showSimpleSuccessNotification(`‚úÖ Absensi berhasil disimpan untuk ${successCount} siswa!`);
        
        // Reset form completely
        document.getElementById('kelasAbsensi').value = '';
        document.getElementById('jamAbsensi').value = 'Jam 1-2';
        document.getElementById('tanggalAbsensi').value = new Date().toISOString().split('T')[0];
        
        // Clear student list
        const studentListContainer = document.getElementById('studentList');
        studentListContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Pilih kelas untuk menampilkan daftar siswa</p>';
        
        // Reload attendance report data to reflect changes
        setTimeout(() => {
          loadAttendanceReportData();
        }, 1000);
      } else {
        alert(`‚ö†Ô∏è Absensi tersimpan sebagian!\n\nBerhasil: ${successCount}\nGagal: ${failCount}\nTotal: ${attendanceData.length}\n\nSilakan coba lagi untuk data yang gagal.`);
      }
    }

    function createProgressDialog(totalStudents) {
      const dialog = document.createElement('div');
      dialog.id = 'progressDialog';
      dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      `;

      dialog.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 15px;
          text-align: center;
          min-width: 300px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 15px;">üíæ</div>
          <h3 style="margin: 0 0 15px 0; color: #333;">Menyimpan Absensi</h3>
          <div id="progressText" style="font-size: 18px; font-weight: 600; color: #4CAF50; margin-bottom: 15px;">
            1/${totalStudents}
          </div>
          <div style="
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
          ">
            <div id="progressBar" style="
              width: 0%;
              height: 100%;
              background: linear-gradient(90deg, #4CAF50, #45a049);
              transition: width 0.3s ease;
            "></div>
          </div>
          <p style="margin: 0; color: #666; font-size: 14px;">
            Mohon tunggu, sedang menyimpan data ke server...
          </p>
        </div>
      `;

      return dialog;
    }

    function createGradesProgressDialog(totalStudents) {
      const dialog = document.createElement('div');
      dialog.id = 'progressDialog';
      dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      `;

      dialog.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 15px;
          text-align: center;
          min-width: 300px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 15px;">‚≠ê</div>
          <h3 style="margin: 0 0 15px 0; color: #333;">Menyimpan Nilai</h3>
          <div id="progressText" style="font-size: 18px; font-weight: 600; color: #4CAF50; margin-bottom: 15px;">
            1/${totalStudents}
          </div>
          <div style="
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
          ">
            <div id="progressBar" style="
              width: 0%;
              height: 100%;
              background: linear-gradient(90deg, #4CAF50, #45a049);
              transition: width 0.3s ease;
            "></div>
          </div>
          <p style="margin: 0; color: #666; font-size: 14px;">
            Mohon tunggu, sedang menyimpan data ke server...
          </p>
        </div>
      `;

      return dialog;
    }

    function createJournalLoadingDialog() {
      const dialog = document.createElement('div');
      dialog.id = 'journalLoadingDialog';
      dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      `;

      dialog.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 15px;
          text-align: center;
          min-width: 300px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 48px; margin-bottom: 15px; animation: spin 2s linear infinite;">üìñ</div>
          <h3 style="margin: 0 0 15px 0; color: #333;">Menyimpan Jurnal</h3>
          <div style="
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
          ">
            <div style="
              width: 100%;
              height: 100%;
              background: linear-gradient(90deg, #2196F3, #1976D2);
              animation: pulse 1.5s ease-in-out infinite;
            "></div>
          </div>
          <p style="margin: 0; color: #666; font-size: 14px;">
            Mohon tunggu, sedang menyimpan jurnal ke server...
          </p>
        </div>
      `;

      return dialog;
    }

    function updateProgress(current, total) {
      const progressText = document.getElementById('progressText');
      const progressBar = document.getElementById('progressBar');
      
      if (progressText && progressBar) {
        progressText.textContent = `${current}/${total}`;
        const percentage = (current / total) * 100;
        progressBar.style.width = `${percentage}%`;
      }
    }

    function loadStudentsForGrades() {
      const kelas = document.getElementById('kelasNilai').value;
      const tableBody = document.getElementById('gradesTableBody');

      if (!kelas) {
        tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666; padding: 20px; font-size: 13px;">Pilih kelas terlebih dahulu</td></tr>';
        return;
      }

      const students = studentsData[kelas] || [];
      
      const tableHTML = students.map((student, index) => `
        <tr>
          <td style="font-size: 13px; padding: 10px 8px;">${index + 1}</td>
          <td style="font-size: 13px; padding: 10px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">${student.nama}</td>
          <td style="padding: 10px 8px;">
            <input type="number" class="nilai-input" min="0" max="100" placeholder="0-100" data-nis="${student.nis}" style="font-size: 13px;">
          </td>
        </tr>
      `).join('');

      tableBody.innerHTML = tableHTML;
    }

    async function saveGrades() {
      const kelas = document.getElementById('kelasNilai').value;
      const mapel = document.getElementById('mapelNilai').value;
      const jenis = document.getElementById('jenisNilai').value;
      const topik = document.getElementById('topikNilai').value;
      const guru = document.getElementById('guruNilai').value;

      if (!kelas || !mapel || !jenis || !topik || !guru) {
        alert('Harap lengkapi semua field!');
        return;
      }

      // Collect grades data
      const gradesData = [];
      const nilaiInputs = document.querySelectorAll('.nilai-input');
      
      nilaiInputs.forEach(input => {
        const nilai = input.value;
        const nis = input.dataset.nis;
        const row = input.closest('tr');
        const nama = row.cells[1].textContent;
        
        if (nilai && nilai.trim() !== '') {
          const nilaiInt = parseInt(nilai);
          if (nilaiInt >= 0 && nilaiInt <= 100) {
            gradesData.push({
              nis: nis,
              nama: nama,
              nilai: nilaiInt
            });
          }
        }
      });

      if (gradesData.length === 0) {
        alert('Harap input minimal satu nilai yang valid (0-100)!');
        return;
      }

      // Show progress dialog
      const progressDialog = createGradesProgressDialog(gradesData.length);
      document.body.appendChild(progressDialog);

      const scriptUrl = 'https://script.google.com/macros/s/AKfycbxTPAT52yNYIJQmRIrTWwkIv5j-K-2vAJoenrV5je5b269p947H-VkrpQUC_Y9pbuKdBQ/exec';
      const today = new Date().toISOString().split('T')[0];
      
      let successCount = 0;
      let failCount = 0;

      // Save each student's grade
      for (let i = 0; i < gradesData.length; i++) {
        const student = gradesData[i];
        
        // Update progress
        updateProgress(i + 1, gradesData.length);
        
        try {
          // Create form data with exact parameter names matching your script
          const formData = new FormData();
          formData.append('tanggal', today);
          formData.append('Kelas', kelas);
          formData.append('Matapelajaran', mapel);
          formData.append('Jenispenilaian', jenis);
          formData.append('Topik', topik);
          formData.append('Guru', guru);
          formData.append('Siswa', student.nama);
          formData.append('Nilai', student.nilai.toString());

          console.log('Sending grade data:', {
            tanggal: today,
            Kelas: kelas,
            Matapelajaran: mapel,
            Jenispenilaian: jenis,
            Topik: topik,
            Guru: guru,
            Siswa: student.nama,
            Nilai: student.nilai
          });

          const response = await fetch(scriptUrl, {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          console.log('Response for student', student.nama, ':', result);
          
          if (result.status === 'sukses') {
            successCount++;
          } else {
            failCount++;
            console.error('Error saving grade for student:', student.nama, result.pesan);
          }
        } catch (error) {
          failCount++;
          console.error('Network error for student:', student.nama, error);
        }

        // Small delay to show progress
        await new Promise(resolve => setTimeout(resolve, 300));
      }

      // Remove progress dialog
      document.body.removeChild(progressDialog);

      // Show result notification
      if (successCount === gradesData.length) {
        showSimpleSuccessNotification(`‚úÖ Nilai berhasil disimpan untuk ${successCount} siswa!`);
        
        // Reset form completely
        document.getElementById('kelasNilai').value = '';
        document.getElementById('jenisNilai').value = 'Tugas';
        document.getElementById('topikNilai').value = '';
        
        // Clear grades table
        const tableBody = document.getElementById('gradesTableBody');
        tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #666; padding: 20px; font-size: 13px;">Pilih kelas untuk menampilkan daftar siswa</td></tr>';
      } else {
        alert(`‚ö†Ô∏è Nilai tersimpan sebagian!\n\nBerhasil: ${successCount}\nGagal: ${failCount}\nTotal: ${gradesData.length}\n\nSilakan coba lagi untuk data yang gagal.`);
      }
    }

    // Function to check for duplicate journal entry
    function checkJournalDuplicate() {
      const kelas = document.getElementById('kelasJurnal').value;
      const tanggal = document.getElementById('tanggalJurnal').value;
      const jam = document.getElementById('jamJurnal').value;
      const materiContainer = document.querySelector('.form-group:has(#materiJurnal)');
      const actionButtons = document.querySelector('#jurnalContent .action-buttons');

      if (!kelas || !tanggal || !jam) {
        // Show form if any field is empty
        if (materiContainer) {
          materiContainer.style.display = 'block';
        }
        if (actionButtons) {
          actionButtons.style.display = 'flex';
        }
        
        // Remove warning if exists
        const warningDiv = document.getElementById('journalDuplicateWarning');
        if (warningDiv) {
          warningDiv.remove();
        }
        return;
      }

      // Check for duplicate journal entry
      const isDuplicate = journalReportData.some(record => {
        return record.kelas === kelas && 
               record.tanggal === tanggal && 
               record.jam === jam;
      });

      if (isDuplicate) {
        // Hide materi form and action buttons
        if (materiContainer) {
          materiContainer.style.display = 'none';
        }
        if (actionButtons) {
          actionButtons.style.display = 'none';
        }

        // Show duplicate warning after filter section
        const filterSection = document.querySelector('#jurnalContent .filter-section').parentElement;
        let warningDiv = document.getElementById('journalDuplicateWarning');
        
        if (!warningDiv) {
          warningDiv = document.createElement('div');
          warningDiv.id = 'journalDuplicateWarning';
          filterSection.insertAdjacentElement('afterend', warningDiv);
        }

        warningDiv.innerHTML = `
          <div style="text-align: center; padding: 30px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; margin: 20px 0;">
            <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
            <h3 style="color: #856404; margin: 0 0 10px 0;">Jurnal Sudah Diisi!</h3>
            <p style="color: #856404; margin: 0; font-size: 14px; line-height: 1.5;">
              Jurnal untuk <strong>Kelas ${kelas}</strong> pada tanggal <strong>${formatDate(tanggal)}</strong> 
              dan <strong>${jam}</strong> sudah pernah diinput sebelumnya.
            </p>
            <p style="color: #856404; margin: 10px 0 0 0; font-size: 13px; font-style: italic;">
              Silakan pilih kelas, tanggal, atau jam yang berbeda.
            </p>
          </div>
        `;
      } else {
        // Show form if no duplicate
        if (materiContainer) {
          materiContainer.style.display = 'block';
        }
        if (actionButtons) {
          actionButtons.style.display = 'flex';
        }

        // Remove warning if exists
        const warningDiv = document.getElementById('journalDuplicateWarning');
        if (warningDiv) {
          warningDiv.remove();
        }
      }
    }

    async function saveJournal() {
      const tanggal = document.getElementById('tanggalJurnal').value;
      const guru = document.getElementById('guruJurnal').value;
      const kelas = document.getElementById('kelasJurnal').value;
      const jam = document.getElementById('jamJurnal').value;
      const mapel = document.getElementById('mapelJurnal').value;
      const materi = document.getElementById('materiJurnal').value;

      if (!tanggal || !guru || !kelas || !jam || !mapel || !materi) {
        alert('Harap lengkapi semua field!');
        return;
      }

      // Check for duplicate journal entry
      const isDuplicate = journalReportData.some(record => {
        return record.kelas === kelas && 
               record.tanggal === tanggal && 
               record.jam === jam;
      });

      if (isDuplicate) {
        alert(`‚ùå Jurnal di kelas ${kelas} pada tanggal ${formatDate(tanggal)} dan ${jam} sudah di input!\n\nSilakan pilih kelas, tanggal, atau jam yang berbeda.`);
        return;
      }

      // Show loading notification
      const loadingDialog = createJournalLoadingDialog();
      document.body.appendChild(loadingDialog);

      try {
        const scriptUrl = 'https://script.google.com/macros/s/AKfycbyXPAe7s8PCqCxOUrpQo0AFeU2Xilr1yhr0y08eVsimupP_c8Fi0d2UEoyLMJieHo5R4Q/exec';
        const currentTime = new Date().toLocaleTimeString('id-ID');

        const formData = new FormData();
        formData.append('tanggal', tanggal);
        formData.append('Waktu', currentTime);
        formData.append('Guru', guru);
        formData.append('Mapel', mapel);
        formData.append('kelas', kelas);
        formData.append('jamKe', jam);
        formData.append('Materi', materi);

        const response = await fetch(scriptUrl, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        // Remove loading dialog
        document.body.removeChild(loadingDialog);

        if (result.status === 'sukses') {
          // Show simple success notification
          showSimpleSuccessNotification('‚úÖ Jurnal berhasil disimpan!');
          
          // Reset form completely
          document.getElementById('tanggalJurnal').value = new Date().toISOString().split('T')[0];
          document.getElementById('kelasJurnal').value = '';
          document.getElementById('jamJurnal').value = 'Jam 1-2';
          document.getElementById('materiJurnal').value = '';
        } else {
          alert(`‚ùå Gagal menyimpan jurnal!\n\nError: ${result.pesan}`);
        }

      } catch (error) {
        console.error('Error saving journal:', error);
        
        // Remove loading dialog if still present
        if (document.body.contains(loadingDialog)) {
          document.body.removeChild(loadingDialog);
        }
        
        alert('‚ùå Terjadi kesalahan saat menyimpan jurnal. Silakan coba lagi.');
      }
    }

    function clearJournal() {
      document.getElementById('materiJurnal').value = '';
    }

    function filterAttendanceReport() {
      const kelas = document.getElementById('kelasRekapAbsensi').value;
      const guru = document.getElementById('guruRekapAbsensi').value;
      const mapel = document.getElementById('mapelRekapAbsensi').value;
      const tanggalAwal = document.getElementById('tanggalAwalAbsensi').value;
      const tanggalAkhir = document.getElementById('tanggalAkhirAbsensi').value;

      // Filter data based on criteria
      let filteredData = attendanceReportData.filter(record => {
        let matches = true;

        if (kelas && record.kelas !== kelas) matches = false;
        if (guru && record.guru !== guru) matches = false;
        if (mapel && record.mapel !== mapel) matches = false;
        
        if (tanggalAwal && record.tanggal < tanggalAwal) matches = false;
        if (tanggalAkhir && record.tanggal > tanggalAkhir) matches = false;

        return matches;
      });

      // Display filtered data
      displayAttendanceReport(filteredData);
      updateAttendanceStats(filteredData);
      
      // Show success message
      const totalRecords = filteredData.length;
      showSimpleSuccessNotification(`Filter berhasil diterapkan! Ditemukan ${totalRecords} data absensi.`);
    }

    function displayAttendanceReport(data) {
      const tableBody = document.getElementById('attendanceReportTable');
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666; padding: 20px;">Tidak ada data absensi yang sesuai dengan filter</td></tr>';
        return;
      }

      const tableHTML = data.map(record => {
        const statusColor = getStatusColor(record.status);
        return `
          <tr>
            <td>${formatDate(record.tanggal)}</td>
            <td>${record.nama}</td>
            <td>${record.lp}</td>
            <td>${record.kelas}</td>
            <td>${record.jam}</td>
            <td>${record.mapel}</td>
            <td><span style="color: ${statusColor}; font-weight: 600;">${record.status}</span></td>
          </tr>
        `;
      }).join('');

      tableBody.innerHTML = tableHTML;
    }

    function displayAttendanceSummary(data) {
      const tableBody = document.getElementById('attendanceSummaryTable');
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #666; padding: 20px;">Tidak ada data absensi yang sesuai dengan filter</td></tr>';
        return;
      }

      // Group data by student
      const studentSummary = {};
      
      data.forEach(record => {
        const key = `${record.nama}_${record.kelas}`;
        
        if (!studentSummary[key]) {
          studentSummary[key] = {
            nama: record.nama,
            kelas: record.kelas,
            lp: record.lp,
            hadir: 0,
            sakit: 0,
            izin: 0,
            alpha: 0,
            total: 0
          };
        }
        
        const status = record.status.toLowerCase();
        if (status === 'hadir') studentSummary[key].hadir++;
        else if (status === 'sakit') studentSummary[key].sakit++;
        else if (status === 'izin') studentSummary[key].izin++;
        else if (status === 'alpha') studentSummary[key].alpha++;
        
        studentSummary[key].total++;
      });

      // Convert to array and group by class, then sort
      const summaryArray = Object.values(studentSummary);
      
      // Group by class
      const groupedByClass = {};
      summaryArray.forEach(student => {
        if (!groupedByClass[student.kelas]) {
          groupedByClass[student.kelas] = [];
        }
        groupedByClass[student.kelas].push(student);
      });
      
      // Sort classes and students within each class
      const sortedClasses = Object.keys(groupedByClass).sort();
      let tableHTML = '';
      let globalIndex = 1;
      
      sortedClasses.forEach(kelas => {
        // Sort students alphabetically within each class
        const studentsInClass = groupedByClass[kelas].sort((a, b) => a.nama.localeCompare(b.nama));
        
        // Add class header row
        tableHTML += `
          <tr style="background: #e8f5e8; font-weight: bold;">
            <td colspan="10" style="text-align: center; padding: 12px; font-size: 16px; color: #4CAF50;">
              üìö KELAS ${kelas} (${studentsInClass.length} Siswa)
            </td>
          </tr>
        `;
        
        // Add students in this class
        studentsInClass.forEach(student => {
          const attendancePercentage = student.total > 0 ? ((student.hadir / student.total) * 100).toFixed(1) : '0.0';
          const percentageColor = parseFloat(attendancePercentage) >= 80 ? '#4CAF50' : parseFloat(attendancePercentage) >= 60 ? '#FF9800' : '#f44336';
          
          tableHTML += `
            <tr>
              <td>${globalIndex}</td>
              <td>${student.nama}</td>
              <td style="font-weight: 600; color: #666;">${student.kelas}</td>
              <td>${student.lp}</td>
              <td style="color: #4CAF50; font-weight: 600;">${student.hadir}</td>
              <td style="color: #FF9800; font-weight: 600;">${student.sakit}</td>
              <td style="color: #2196F3; font-weight: 600;">${student.izin}</td>
              <td style="color: #f44336; font-weight: 600;">${student.alpha}</td>
              <td style="font-weight: 600;">${student.total}</td>
              <td style="color: ${percentageColor}; font-weight: 600;">${attendancePercentage}%</td>
            </tr>
          `;
          globalIndex++;
        });
      });

      tableBody.innerHTML = tableHTML;
    }

    function updateAttendanceStats(data) {
      if (data.length === 0) {
        document.getElementById('attendancePercentage').textContent = '0%';
        document.getElementById('sickPercentage').textContent = '0%';
        document.getElementById('permitPercentage').textContent = '0%';
        document.getElementById('absentPercentage').textContent = '0%';
        return;
      }

      const stats = {
        hadir: 0,
        sakit: 0,
        izin: 0,
        alpha: 0
      };

      data.forEach(record => {
        const status = record.status.toLowerCase();
        if (stats.hasOwnProperty(status)) {
          stats[status]++;
        }
      });

      const total = data.length;
      const attendancePercentage = ((stats.hadir / total) * 100).toFixed(1);
      const sickPercentage = ((stats.sakit / total) * 100).toFixed(1);
      const permitPercentage = ((stats.izin / total) * 100).toFixed(1);
      const absentPercentage = ((stats.alpha / total) * 100).toFixed(1);

      document.getElementById('attendancePercentage').textContent = `${attendancePercentage}%`;
      document.getElementById('sickPercentage').textContent = `${sickPercentage}%`;
      document.getElementById('permitPercentage').textContent = `${permitPercentage}%`;
      document.getElementById('absentPercentage').textContent = `${absentPercentage}%`;
    }

    function getStatusColor(status) {
      const colors = {
        'Hadir': '#4CAF50',
        'Sakit': '#FF9800',
        'Izin': '#2196F3',
        'Alpha': '#f44336'
      };
      return colors[status] || '#666';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('id-ID', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }

    function toggleReportView() {
      const detailedView = document.getElementById('detailedReportView');
      const summaryView = document.getElementById('summaryReportView');
      const toggleBtn = document.getElementById('toggleViewBtn');

      if (detailedView.classList.contains('hidden')) {
        // Switch to detailed view
        detailedView.classList.remove('hidden');
        summaryView.classList.add('hidden');
        toggleBtn.innerHTML = 'Tampilan Ringkas';
      } else {
        // Switch to summary view
        detailedView.classList.add('hidden');
        summaryView.classList.remove('hidden');
        toggleBtn.innerHTML = 'Tampilan Rinci';
        
        // Update summary view with current filtered data
        const kelas = document.getElementById('kelasRekapAbsensi').value;
        const guru = document.getElementById('guruRekapAbsensi').value;
        const mapel = document.getElementById('mapelRekapAbsensi').value;
        const tanggalAwal = document.getElementById('tanggalAwalAbsensi').value;
        const tanggalAkhir = document.getElementById('tanggalAkhirAbsensi').value;

        let filteredData = attendanceReportData.filter(record => {
          let matches = true;
          if (kelas && record.kelas !== kelas) matches = false;
          if (guru && record.guru !== guru) matches = false;
          if (mapel && record.mapel !== mapel) matches = false;
          if (tanggalAwal && record.tanggal < tanggalAwal) matches = false;
          if (tanggalAkhir && record.tanggal > tanggalAkhir) matches = false;
          return matches;
        });

        displayAttendanceSummary(filteredData);
      }
    }

    function displayJournalReport(data) {
      const tableBody = document.getElementById('journalReportTable');
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">Tidak ada data jurnal yang sesuai dengan filter</td></tr>';
        return;
      }

      const tableHTML = data.map(record => {
        return `
          <tr>
            <td>${formatDate(record.tanggal)}</td>
            <td>${record.kelas}</td>
            <td>${record.jam}</td>
            <td>${record.mapel}</td>
            <td style="max-width: 300px; word-wrap: break-word;">${record.materi}</td>
            <td>${record.guru}</td>
          </tr>
        `;
      }).join('');

      tableBody.innerHTML = tableHTML;
    }

    function filterJournalReport() {
      const kelas = document.getElementById('kelasRekapJurnal').value;
      const guru = document.getElementById('guruRekapJurnal').value;
      const mapel = document.getElementById('mapelRekapJurnal').value;
      const tanggalAwal = document.getElementById('tanggalAwalJurnal').value;
      const tanggalAkhir = document.getElementById('tanggalAkhirJurnal').value;

      console.log('Filtering journal report for user:', currentUser);
      console.log('Filter criteria:', { kelas, guru, mapel, tanggalAwal, tanggalAkhir });

      // Filter data based on criteria and user access rights
      let filteredData = journalReportData.filter(record => {
        let matches = true;

        // Apply basic filters
        if (kelas && record.kelas !== kelas) matches = false;
        if (guru && record.guru !== guru) matches = false;
        if (mapel && record.mapel !== mapel) matches = false;
        
        if (tanggalAwal && record.tanggal < tanggalAwal) matches = false;
        if (tanggalAkhir && record.tanggal > tanggalAkhir) matches = false;

        // Apply access control - non-administrators can only see their own journals
        if (currentUser && currentUser.role !== 'Administrator') {
          if (record.guru !== currentUser.name) {
            matches = false;
            console.log('Filtered out journal from other teacher:', record.guru, 'vs current user:', currentUser.name);
          }
        }

        return matches;
      });

      console.log('Filtered journal data:', filteredData.length, 'records');

      // Display filtered data
      displayJournalReport(filteredData);
      
      // Show success message
      const totalRecords = filteredData.length;
      if (currentUser && currentUser.role !== 'Administrator') {
        showSimpleSuccessNotification(`Filter berhasil diterapkan! Ditemukan ${totalRecords} data jurnal Anda.`);
      } else {
        showSimpleSuccessNotification(`Filter berhasil diterapkan! Ditemukan ${totalRecords} data jurnal.`);
      }
    }

    function filterGradesReport() {
      const kelas = document.getElementById('kelasRekapNilai').value;
      const mapel = document.getElementById('mapelRekapNilai').value;
      const jenis = document.getElementById('jenisRekapNilai').value;

      console.log('Filtering grades report for user:', currentUser);
      console.log('Filter criteria:', { kelas, mapel, jenis });

      // Use real data from Google Sheets
      let filteredData = gradesReportData.filter(record => {
        let matches = true;

        // Apply basic filters
        if (kelas && record.kelas !== kelas) matches = false;
        if (mapel && record.mapel !== mapel) matches = false;
        if (jenis && record.jenis !== jenis) matches = false;

        // Apply access control based on user role
        if (currentUser) {
          if (currentUser.role === 'Administrator') {
            // Administrator can see all grades - no additional filtering
          } else if (currentUser.role.includes('Wali Kelas')) {
            // Wali Kelas can see all grades for their homeroom class
            const kelasFromRole = extractClassFromRole(currentUser.role);
            console.log('Wali Kelas filtering for homeroom class:', kelasFromRole);
            
            if (kelasFromRole && record.kelas !== kelasFromRole) {
              matches = false;
              console.log('Filtered out grade from other class:', record.kelas, 'vs homeroom class:', kelasFromRole);
            }
          } else {
            // Regular teachers can only see their own grades
            if (record.guru !== currentUser.name) {
              matches = false;
              console.log('Filtered out grade from other teacher:', record.guru, 'vs current user:', currentUser.name);
            }
          }
        }

        return matches;
      });

      console.log('Final filtered grades data:', filteredData.length, 'records');

      // Display filtered data
      displayGradesReport(filteredData);
      updateGradesStats(filteredData);
      
      // Show success message
      const totalRecords = filteredData.length;
      if (currentUser) {
        if (currentUser.role === 'Administrator') {
          showSimpleSuccessNotification(`Filter berhasil diterapkan! Ditemukan ${totalRecords} data nilai.`);
        } else if (currentUser.role.includes('Wali Kelas')) {
          const kelasFromRole = extractClassFromRole(currentUser.role);
          showSimpleSuccessNotification(`Filter berhasil diterapkan! Ditemukan ${totalRecords} data nilai kelas ${kelasFromRole}.`);
        } else {
          showSimpleSuccessNotification(`Filter berhasil diterapkan! Ditemukan ${totalRecords} data nilai Anda.`);
        }
      } else {
        showSimpleSuccessNotification(`Filter berhasil diterapkan! Ditemukan ${totalRecords} data nilai.`);
      }
    }

    function displayGradesReport(data) {
      const tableBody = document.getElementById('gradesReportTable');
      
      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666; padding: 20px;">Tidak ada data nilai yang sesuai dengan filter</td></tr>';
        return;
      }

      const tableHTML = data.map(record => {
        const nilaiColor = getNilaiColor(record.nilai);
        return `
          <tr>
            <td>${record.nama}</td>
            <td>${record.kelas}</td>
            <td>${record.mapel}</td>
            <td>${record.jenis}</td>
            <td>${record.topik}</td>
            <td><span style="color: ${nilaiColor}; font-weight: 600;">${record.nilai}</span></td>
          </tr>
        `;
      }).join('');

      tableBody.innerHTML = tableHTML;
    }

    function updateGradesStats(data) {
      if (data.length === 0) {
        document.getElementById('averageGrade').textContent = '0';
        document.getElementById('highestGrade').textContent = '0';
        document.getElementById('lowestGrade').textContent = '0';
        document.getElementById('totalStudents').textContent = '0';
        return;
      }

      const grades = data.map(record => record.nilai);
      const average = (grades.reduce((sum, grade) => sum + grade, 0) / grades.length).toFixed(1);
      const highest = Math.max(...grades);
      const lowest = Math.min(...grades);
      const total = data.length;

      document.getElementById('averageGrade').textContent = average;
      document.getElementById('highestGrade').textContent = highest;
      document.getElementById('lowestGrade').textContent = lowest;
      document.getElementById('totalStudents').textContent = total;
    }

    function getNilaiColor(nilai) {
      if (nilai >= 85) return '#4CAF50';  // Green for excellent
      if (nilai >= 75) return '#2196F3';  // Blue for good
      if (nilai >= 65) return '#FF9800';  // Orange for fair
      return '#f44336';  // Red for poor
    }

    function showAttendanceStats() {
      alert('Menampilkan statistik kehadiran!');
    }

    function showGradesStats() {
      alert('Menampilkan statistik nilai!');
    }

    function downloadPDF(type) {
      // Get current filter values based on type
      let filters = {};
      let filteredData = [];
      let viewType = 'detailed'; // Default view type
      
      if (type === 'absensi') {
        filters = {
          kelas: document.getElementById('kelasRekapAbsensi').value,
          guru: document.getElementById('guruRekapAbsensi').value,
          mapel: document.getElementById('mapelRekapAbsensi').value,
          tanggalAwal: document.getElementById('tanggalAwalAbsensi').value,
          tanggalAkhir: document.getElementById('tanggalAkhirAbsensi').value
        };
        
        // Determine current view type based on which view is visible
        const detailedView = document.getElementById('detailedReportView');
        const summaryView = document.getElementById('summaryReportView');
        
        if (summaryView && !summaryView.classList.contains('hidden')) {
          viewType = 'summary';
        } else {
          viewType = 'detailed';
        }
        
        // Filter attendance data
        filteredData = attendanceReportData.filter(record => {
          let matches = true;
          if (filters.kelas && record.kelas !== filters.kelas) matches = false;
          if (filters.guru && record.guru !== filters.guru) matches = false;
          if (filters.mapel && record.mapel !== filters.mapel) matches = false;
          if (filters.tanggalAwal && record.tanggal < filters.tanggalAwal) matches = false;
          if (filters.tanggalAkhir && record.tanggal > filters.tanggalAkhir) matches = false;
          
          // Apply access control for non-administrators
          if (currentUser && currentUser.role !== 'Administrator') {
            if (currentUser.role.includes('Wali Kelas')) {
              const kelasFromRole = extractClassFromRole(currentUser.role);
              if (kelasFromRole && record.kelas !== kelasFromRole) matches = false;
            } else if (record.guru !== currentUser.name) {
              matches = false;
            }
          }
          
          return matches;
        });
        
      } else if (type === 'jurnal') {
        filters = {
          kelas: document.getElementById('kelasRekapJurnal').value,
          guru: document.getElementById('guruRekapJurnal').value,
          mapel: document.getElementById('mapelRekapJurnal').value,
          tanggalAwal: document.getElementById('tanggalAwalJurnal').value,
          tanggalAkhir: document.getElementById('tanggalAkhirJurnal').value
        };
        
        // Filter journal data
        filteredData = journalReportData.filter(record => {
          let matches = true;
          if (filters.kelas && record.kelas !== filters.kelas) matches = false;
          if (filters.guru && record.guru !== filters.guru) matches = false;
          if (filters.mapel && record.mapel !== filters.mapel) matches = false;
          if (filters.tanggalAwal && record.tanggal < filters.tanggalAwal) matches = false;
          if (filters.tanggalAkhir && record.tanggal > filters.tanggalAkhir) matches = false;
          
          // Apply access control for non-administrators
          if (currentUser && currentUser.role !== 'Administrator') {
            if (record.guru !== currentUser.name) matches = false;
          }
          
          return matches;
        });
        
      } else if (type === 'nilai') {
        filters = {
          kelas: document.getElementById('kelasRekapNilai').value,
          mapel: document.getElementById('mapelRekapNilai').value,
          jenis: document.getElementById('jenisRekapNilai').value
        };
        
        // Filter grades data
        filteredData = gradesReportData.filter(record => {
          let matches = true;
          if (filters.kelas && record.kelas !== filters.kelas) matches = false;
          if (filters.mapel && record.mapel !== filters.mapel) matches = false;
          if (filters.jenis && record.jenis !== filters.jenis) matches = false;
          
          // Apply access control based on user role
          if (currentUser) {
            if (currentUser.role === 'Administrator') {
              // Administrator can see all grades
            } else if (currentUser.role.includes('Wali Kelas')) {
              const kelasFromRole = extractClassFromRole(currentUser.role);
              if (kelasFromRole && record.kelas !== kelasFromRole) matches = false;
            } else if (record.guru !== currentUser.name) {
              matches = false;
            }
          }
          
          return matches;
        });
      }
      
      // Generate and open PDF with view type
      generatePDF(type, filteredData, filters, viewType);
    }

    function generatePDF(type, data, filters, viewType = 'detailed') {
      // Create PDF content HTML
      const pdfContent = createPDFContent(type, data, filters, viewType);
      
      // Create a new window/tab with the PDF content
      const pdfWindow = window.open('', '_blank', 'width=800,height=600');
      
      if (pdfWindow) {
        pdfWindow.document.write(pdfContent);
        pdfWindow.document.close();
        
        // Auto-print dialog after content loads
        pdfWindow.onload = function() {
          setTimeout(() => {
            pdfWindow.print();
          }, 500);
        };
      } else {
        alert('Pop-up diblokir! Silakan izinkan pop-up untuk download PDF.');
      }
    }

    function createPDFContent(type, data, filters, viewType = 'detailed') {
      const currentDate = new Date().toLocaleDateString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      let title = '';
      let tableHeaders = '';
      let tableRows = '';
      
      if (type === 'absensi') {
        if (viewType === 'summary') {
          title = 'Laporan Rekap Absensi Siswa (Ringkasan per Siswa)';
          tableHeaders = `
            <tr style="background: #f8f9fa;">
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">No</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nama Siswa</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Kelas</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">L/P</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #4CAF50;">Hadir</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #FF9800;">Sakit</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #2196F3;">Izin</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #f44336;">Alpha</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Total</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">% Kehadiran</th>
            </tr>
          `;
          
          // Group data by student for summary view
          const studentSummary = {};
          
          data.forEach(record => {
            const key = `${record.nama}_${record.kelas}`;
            
            if (!studentSummary[key]) {
              studentSummary[key] = {
                nama: record.nama,
                kelas: record.kelas,
                lp: record.lp,
                hadir: 0,
                sakit: 0,
                izin: 0,
                alpha: 0,
                total: 0
              };
            }
            
            const status = record.status.toLowerCase();
            if (status === 'hadir') studentSummary[key].hadir++;
            else if (status === 'sakit') studentSummary[key].sakit++;
            else if (status === 'izin') studentSummary[key].izin++;
            else if (status === 'alpha') studentSummary[key].alpha++;
            
            studentSummary[key].total++;
          });

          // Convert to array and group by class, then sort
          const summaryArray = Object.values(studentSummary);
          
          // Group by class
          const groupedByClass = {};
          summaryArray.forEach(student => {
            if (!groupedByClass[student.kelas]) {
              groupedByClass[student.kelas] = [];
            }
            groupedByClass[student.kelas].push(student);
          });
          
          // Sort classes and students within each class
          const sortedClasses = Object.keys(groupedByClass).sort();
          let globalIndex = 1;
          
          tableRows = sortedClasses.map(kelas => {
            // Sort students alphabetically within each class
            const studentsInClass = groupedByClass[kelas].sort((a, b) => a.nama.localeCompare(b.nama));
            
            // Create class header row
            let classRows = `
              <tr style="background: #e8f5e8; font-weight: bold;">
                <td colspan="10" style="border: 1px solid #ddd; text-align: center; padding: 12px; font-size: 16px; color: #4CAF50;">
                  üìö KELAS ${kelas} (${studentsInClass.length} Siswa)
                </td>
              </tr>
            `;
            
            // Add students in this class
            studentsInClass.forEach(student => {
              const attendancePercentage = student.total > 0 ? ((student.hadir / student.total) * 100).toFixed(1) : '0.0';
              const percentageColor = parseFloat(attendancePercentage) >= 80 ? '#4CAF50' : parseFloat(attendancePercentage) >= 60 ? '#FF9800' : '#f44336';
              
              classRows += `
                <tr>
                  <td style="border: 1px solid #ddd; padding: 8px;">${globalIndex}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">${student.nama}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; font-weight: 600; color: #666;">${student.kelas}</td>
                  <td style="border: 1px solid #ddd; padding: 8px;">${student.lp}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #4CAF50; font-weight: 600;">${student.hadir}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #FF9800; font-weight: 600;">${student.sakit}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #2196F3; font-weight: 600;">${student.izin}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: #f44336; font-weight: 600;">${student.alpha}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center; font-weight: 600;">${student.total}</td>
                  <td style="border: 1px solid #ddd; padding: 8px; text-align: center; color: ${percentageColor}; font-weight: 600;">${attendancePercentage}%</td>
                </tr>
              `;
              globalIndex++;
            });
            
            return classRows;
          }).join('');
          
        } else {
          // Detailed view (original)
          title = 'Laporan Rekap Absensi Siswa (Data Rinci)';
          tableHeaders = `
            <tr style="background: #f8f9fa;">
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">No</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Tanggal</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nama Siswa</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">L/P</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Kelas</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Jam</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Mata Pelajaran</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Status</th>
            </tr>
          `;
          
          tableRows = data.map((record, index) => `
            <tr>
              <td style="border: 1px solid #ddd; padding: 8px;">${index + 1}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">${formatDate(record.tanggal)}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">${record.nama}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">${record.lp}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">${record.kelas}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">${record.jam}</td>
              <td style="border: 1px solid #ddd; padding: 8px;">${record.mapel}</td>
              <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${record.status}</td>
            </tr>
          `).join('');
        }
        
      } else if (type === 'jurnal') {
        title = 'Laporan Rekap Jurnal Mengajar';
        tableHeaders = `
          <tr style="background: #f8f9fa;">
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">No</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Tanggal</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Kelas</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Jam</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Mata Pelajaran</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Materi</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Guru</th>
          </tr>
        `;
        
        tableRows = data.map((record, index) => `
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">${index + 1}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${formatDate(record.tanggal)}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${record.kelas}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${record.jam}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${record.mapel}</td>
            <td style="border: 1px solid #ddd; padding: 8px; max-width: 300px; word-wrap: break-word;">${record.materi}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${record.guru}</td>
          </tr>
        `).join('');
        
      } else if (type === 'nilai') {
        title = 'Laporan Rekap Nilai Siswa';
        tableHeaders = `
          <tr style="background: #f8f9fa;">
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">No</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nama Siswa</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Kelas</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Mata Pelajaran</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Jenis</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Topik</th>
            <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Nilai</th>
          </tr>
        `;
        
        tableRows = data.map((record, index) => `
          <tr>
            <td style="border: 1px solid #ddd; padding: 8px;">${index + 1}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${record.nama}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${record.kelas}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${record.mapel}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${record.jenis}</td>
            <td style="border: 1px solid #ddd; padding: 8px;">${record.topik}</td>
            <td style="border: 1px solid #ddd; padding: 8px; font-weight: bold; text-align: center;">${record.nilai}</td>
          </tr>
        `).join('');
      }
      
      // Create filter summary
      let filterSummary = '<div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">';
      filterSummary += '<h4 style="margin: 0 0 10px 0; color: #333;">Filter yang Diterapkan:</h4>';
      
      Object.keys(filters).forEach(key => {
        if (filters[key]) {
          const filterLabels = {
            kelas: 'Kelas',
            guru: 'Guru',
            mapel: 'Mata Pelajaran',
            jenis: 'Jenis Penilaian',
            tanggalAwal: 'Tanggal Awal',
            tanggalAkhir: 'Tanggal Akhir'
          };
          filterSummary += `<p style="margin: 5px 0;"><strong>${filterLabels[key]}:</strong> ${filters[key]}</p>`;
        }
      });
      
      if (Object.values(filters).every(val => !val)) {
        filterSummary += '<p style="margin: 5px 0; font-style: italic;">Semua data ditampilkan (tidak ada filter)</p>';
      }
      
      filterSummary += '</div>';
      
      return `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>${title} - SMP Al-Azhar Muncar</title>
          <style>
            body {
              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              margin: 20px;
              color: #333;
              line-height: 1.4;
            }
            .header {
              display: flex;
              align-items: center;
              margin-bottom: 30px;
              border-bottom: 2px solid #4CAF50;
              padding-bottom: 20px;
            }
            .school-info {
              flex: 1;
              text-align: center;
            }
            .school-logo {
              width: 80px;
              height: 80px;
              margin-right: 20px;
              flex-shrink: 0;
            }
            .school-name {
              font-size: 24px;
              font-weight: bold;
              color: #4CAF50;
              margin: 0;
            }
            .school-address {
              font-size: 14px;
              color: #666;
              margin: 5px 0;
            }
            .report-title {
              font-size: 20px;
              font-weight: bold;
              margin: 20px 0 10px 0;
              color: #333;
            }
            .report-date {
              font-size: 14px;
              color: #666;
            }
            .info-section {
              display: flex;
              gap: 20px;
              margin: 20px 0;
            }
            .filter-info {
              flex: 1;
              padding: 10px;
              background: #f8f9fa;
              border-radius: 6px;
              font-size: 12px;
            }
            .summary-info {
              flex: 1;
              padding: 10px;
              background: #e8f5e8;
              border-radius: 6px;
              font-size: 12px;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin: 20px 0;
              font-size: 12px;
            }
            th, td {
              border: 1px solid #ddd;
              padding: 8px;
              text-align: left;
            }
            th {
              background: #f8f9fa;
              font-weight: bold;
            }
            .footer {
              margin-top: 40px;
              text-align: right;
              font-size: 12px;
            }
            @media print {
              body { margin: 0; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <img src="https://maualazharmuncar.sch.id/wp-content/uploads/2025/02/LG-SMP.png" alt="Logo SMP Al-Azhar Muncar" class="school-logo" onerror="this.style.display='none';">
            <div class="school-info">
              <h1 class="school-name">SMP AL-AZHAR MUNCAR</h1>
              <p class="school-address">Jl. Ompak Songo Tembokrejo, Muncar, Banyuwangi, Jawa Timur, Indonesia 68472</p>
              <p class="report-date">Dicetak pada: ${currentDate}</p>
              <h2 class="report-title">${title}</h2>
            </div>
          </div>

          <div class="info-section">
            <div class="filter-info">
              <h4 style="margin: 0 0 8px 0; color: #333; font-size: 14px;">Filter yang Diterapkan:</h4>
              ${Object.keys(filters).map(key => {
                if (filters[key]) {
                  const filterLabels = {
                    kelas: 'Kelas',
                    guru: 'Guru',
                    mapel: 'Mata Pelajaran',
                    jenis: 'Jenis Penilaian',
                    tanggalAwal: 'Tanggal Awal',
                    tanggalAkhir: 'Tanggal Akhir'
                  };
                  return `<p style="margin: 3px 0; font-size: 11px;"><strong>${filterLabels[key]}:</strong> ${filters[key]}</p>`;
                }
                return '';
              }).join('') || '<p style="margin: 3px 0; font-style: italic; font-size: 11px;">Semua data ditampilkan (tidak ada filter)</p>'}
            </div>
            
            <div class="summary-info">
              <h4 style="margin: 0 0 8px 0; color: #333; font-size: 14px;">Ringkasan Data:</h4>
              <p style="margin: 3px 0; font-size: 11px;"><strong>Total Data:</strong> ${data.length} record</p>
              <p style="margin: 3px 0; font-size: 11px;"><strong>Dicetak oleh:</strong> ${currentUser ? currentUser.name : 'System'} (${currentUser ? currentUser.role : 'Unknown'})</p>
            </div>
          </div>

          <table>
            <thead>
              ${tableHeaders}
            </thead>
            <tbody>
              ${tableRows || '<tr><td colspan="100%" style="text-align: center; padding: 20px; font-style: italic;">Tidak ada data untuk ditampilkan</td></tr>'}
            </tbody>
          </table>

          <div class="footer">
            <p>Dokumen ini digenerate secara otomatis oleh Sistem Absensi dan Jurnal SMP Al-Azhar Muncar</p>
            <p>Tanggal cetak: ${new Date().toLocaleString('id-ID')}</p>
          </div>
        </body>
        </html>
      `;
    }

    function toggleDropup(event) {
      event.stopPropagation();
      const dropup = document.getElementById('rekapDropup');
      const overlay = document.getElementById('dropupOverlay');
      
      if (dropup.classList.contains('show')) {
        closeDropup();
      } else {
        dropup.classList.add('show');
        overlay.classList.add('show');
      }
    }

    function selectRekapPage(page) {
      closeDropup();
      showPage(page);
    }

    function closeDropup() {
      const dropup = document.getElementById('rekapDropup');
      const overlay = document.getElementById('dropupOverlay');
      
      dropup.classList.remove('show');
      overlay.classList.remove('show');
    }

    // Success notification function
    function showSuccessNotification(title, message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      `;

      notification.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 15px;
          text-align: center;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
          <h2 style="margin: 0 0 20px 0; color: #4CAF50; font-size: 24px; font-weight: 600;">
            ${title}
          </h2>
          <div style="
            text-align: left;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
          ">
            ${message}
          </div>
          <button onclick="closeSuccessNotification()" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
          " onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4CAF50'">
            OK
          </button>
        </div>
      `;

      document.body.appendChild(notification);
      
      // Store reference for closing
      window.currentNotification = notification;
    }

    // Simple success notification function
    function showSimpleSuccessNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      `;

      notification.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 15px;
          text-align: center;
          min-width: 300px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
          <h2 style="margin: 0 0 25px 0; color: #4CAF50; font-size: 24px; font-weight: 600;">
            ${message}
          </h2>
          <button onclick="closeSuccessNotification()" style="
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
          " onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4CAF50'">
            OK
          </button>
        </div>
      `;

      document.body.appendChild(notification);
      
      // Store reference for closing
      window.currentNotification = notification;
    }

    function closeSuccessNotification() {
      if (window.currentNotification) {
        document.body.removeChild(window.currentNotification);
        window.currentNotification = null;
      }
    }



    // Close dropup when clicking outside
    document.addEventListener('click', function(event) {
      const dropup = document.getElementById('rekapDropup');
      const rekapNav = event.target.closest('.nav-item');
      
      if (dropup && dropup.classList.contains('show') && !rekapNav) {
        closeDropup();
      }
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'998c03fde3aa3f31',t:'MTc2MjE3NDQxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
